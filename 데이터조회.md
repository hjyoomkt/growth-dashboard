# 데이터 조회 최적화 작업 - 2026-01-28

## 문제 상황

### 증상
- https://www.zestdot.com/admin/default 및 http://localhost:3000/admin/data-tables
- 상단 네비게이션에서 날짜를 3개월 이상으로 변경 시 최대 1달 데이터만 집계됨
- 실제로는 여러 달의 데이터가 DB에 존재함

### 원인
**Supabase PostgREST 기본 1000행 제한**
- `ad_performance` 테이블: 광고 1개당 1일 1개 행
- 예: 150개 광고 × 90일 = 13,500행 → 1000행만 조회됨
- 클라이언트 측에서 집계하면 불완전한 데이터만 사용

---

## 해결 방법

### 접근법: 서버측 집계 (PostgreSQL 함수 + RPC)
1. PostgreSQL에서 데이터를 미리 집계
2. Supabase RPC로 집계된 결과만 반환
3. 프론트엔드는 집계된 데이터 사용

---

## 작업 내용

### 1. SQL 집계 함수 생성 (12개)

파일: `database/migrations/add_aggregation_functions.sql`

#### 생성된 함수 목록

| 번호 | 함수명 | 용도 | 반환 데이터 |
|------|--------|------|-------------|
| 1 | `get_kpi_aggregated` | KPI 총합 | cost, impressions, clicks, conversions, conversion_value |
| 2 | `get_daily_aggregated` | 일별 집계 | date, cost, impressions, clicks, conversions, conversion_value |
| 3 | `get_media_aggregated` | 매체별 집계 | source, cost, impressions, clicks, conversions, conversion_value |
| 4 | `get_weekly_aggregated` | 주별 집계 | week_start, week_end, week_label, cost, impressions, clicks, conversions, conversion_value |
| 5 | `get_monthly_aggregated` | 월별 집계 | month_date, month_label, cost, impressions, clicks, conversions, conversion_value |
| 6 | `get_weekday_aggregated` | 요일별 집계 | day_of_week, conversions |
| 7 | `get_creative_aggregated` | 크리에이티브별 집계 | ad_id, source, campaign_name, cost, impressions, clicks, conversions, conversion_value |
| 8 | `get_gender_aggregated` | 성별 집계 | gender, conversions |
| 9 | `get_age_gender_aggregated` | 연령대별 성별 집계 | gender, age, conversions |
| 10 | `get_campaign_aggregated` | 캠페인별 집계 | source, campaign_name, cost, impressions, clicks, conversions, conversion_value |
| 11 | `get_ad_group_aggregated` | 광고그룹별 집계 | source, campaign_name, ad_group_name, cost, impressions, clicks, conversions, conversion_value |
| 12 | `get_ad_aggregated` | 광고별 집계 | source, campaign_name, ad_group_name, ad_name, cost, impressions, clicks, conversions, conversion_value |

#### 공통 파라미터
모든 함수는 다음 파라미터를 받습니다:
```sql
p_advertiser_id uuid DEFAULT NULL,           -- 단일 광고주 ID
p_advertiser_ids uuid[] DEFAULT NULL,        -- 여러 광고주 ID 배열
p_start_date date DEFAULT NULL,              -- 시작일
p_end_date date DEFAULT NULL,                -- 종료일
p_meta_conversion_type text DEFAULT 'purchase'  -- Meta 전환 타입
```

#### 주요 특징
- Meta 광고의 경우 `meta_conversion_type`에 따라 분기 처리
  - `purchase`: `conversions`, `conversion_value` 사용
  - `complete_registration`: `complete_registrations`, `complete_registrations_value` 사용
- `deleted_at IS NULL` 필터로 삭제된 데이터 제외
- `COALESCE`로 NULL 값 처리

---

### 2. 프론트엔드 함수 수정 (15개)

파일: `src/services/supabaseService.js`

#### 수정된 함수 목록

| 함수명 | 사용 RPC | 위치(라인) | 영향받는 컴포넌트 |
|--------|----------|-----------|-------------------|
| `getKPIData` | `get_kpi_aggregated` | ~1171 | KPI 카드 (총지출, 노출수, 클릭수, 전환수) |
| `getDailyRevenue` | `get_daily_aggregated` | ~1304 | 일별 매출 차트 |
| `getDailyAdCost` | `get_daily_aggregated` | ~1214 | 일별 광고비 차트 |
| `getMediaAdCost` | `get_media_aggregated` | ~1259 | 매체별 광고비 차트 |
| `getMediaRevenue` | `get_media_aggregated` | ~1305 | 매체별 매출 분석 |
| `getMediaAdSummary` | `get_media_aggregated` | ~1355 | 매체별 광고 요약 |
| `getDailyAdSummary` | `get_daily_aggregated` | ~1665 | 일별 광고 요약 |
| `getWeeklyAdSummary` | `get_weekly_aggregated` | ~1706 | 주별 광고 요약 |
| `getMonthlyAdSummary` | `get_monthly_aggregated` | ~1747 | 월별 광고 요약 |
| `getDailyROASAndCost` | `get_daily_aggregated` | ~1854 | ROAS & 광고비 분석 차트 |
| `getWeeklyConversions` | `get_weekday_aggregated` | ~1021 | 요일별 전환수 차트 |
| `getBestCreatives` | `get_creative_aggregated` | ~1827 | BEST 크리에이티브 (상위 6개) |
| `getAllCreatives` | `get_creative_aggregated` | ~1978 | 전체 크리에이티브 목록 |
| `getCampaignAdSummary` | `get_campaign_aggregated` | ~1331 | 계층별 광고 요약 - 캠페인 탭 |
| `getAdGroupAdSummary` | `get_ad_group_aggregated` | ~1373 | 계층별 광고 요약 - 광고그룹 탭 |
| `getAdAdSummary` | `get_ad_aggregated` | ~1462 | 계층별 광고 요약 - 광고 탭 |
| `getMediaROASAnalysis` | `get_media_aggregated` | ~1584 | 매체별 ROAS 분석 테이블 |

#### 변경 전/후 비교

**변경 전 (직접 쿼리 + 클라이언트 집계)**
```javascript
let query = supabase
  .from('ad_performance')
  .select('date, cost, conversions');

// 필터 추가
if (advertiserId) query = query.eq('advertiser_id', advertiserId);
if (startDate) query = query.gte('date', startDate);
if (endDate) query = query.lte('date', endDate);

const { data, error } = await query; // ❌ 1000행 제한

// 클라이언트에서 집계
const result = data.reduce((acc, row) => {
  // 집계 로직...
}, {});
```

**변경 후 (RPC + 서버 집계)**
```javascript
// Meta 전환 타입 조회
let metaConversionType = 'purchase';
if (advertiserId && advertiserId !== 'all') {
  const { data: advertiserData } = await supabase
    .from('advertisers')
    .select('meta_conversion_type')
    .eq('id', advertiserId)
    .single();
  metaConversionType = advertiserData?.meta_conversion_type || 'purchase';
}

// RPC 호출 - 서버에서 집계된 결과만 반환
const { data, error } = await supabase.rpc('get_daily_aggregated', {
  p_advertiser_id: advertiserId || null,
  p_advertiser_ids: availableAdvertiserIds || null,
  p_start_date: startDate || null,
  p_end_date: endDate || null,
  p_meta_conversion_type: metaConversionType
});

// ✅ 이미 집계된 데이터 사용
return data.map(row => ({
  date: row.date,
  cost: Number(row.cost) || 0
}));
```

---

### 3. 컴포넌트 수정 (2개)

#### 성별/연령대별 구매 분석

**GenderPurchasePie.js**
- 파일: `src/views/admin/default/components/GenderPurchasePie.js`
- RPC 함수: `get_gender_aggregated`
- 변경 사항: 직접 쿼리 → RPC 호출

**AgeGenderPurchase.js**
- 파일: `src/views/admin/default/components/AgeGenderPurchase.js`
- RPC 함수: `get_age_gender_aggregated`
- 변경 사항: 직접 쿼리 → RPC 호출

---

## 실행 방법

### 1. SQL 함수 생성
1. Supabase 대시보드 열기
2. SQL Editor 이동
3. `database/migrations/add_aggregation_functions.sql` 파일 내용 복사
4. 붙여넣기 후 Run 클릭
5. 12개 함수 모두 생성됨

### 2. 함수 확인
```sql
-- 함수 존재 여부 확인
SELECT
  routine_name,
  routine_type
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name LIKE 'get_%aggregated'
ORDER BY routine_name;
```

### 3. 테스트
```sql
-- KPI 테스트
SELECT * FROM get_kpi_aggregated(
  p_advertiser_id := NULL,
  p_advertiser_ids := NULL,
  p_start_date := '2026-01-01',
  p_end_date := '2026-01-28',
  p_meta_conversion_type := 'purchase'
);

-- 일별 집계 테스트
SELECT * FROM get_daily_aggregated(
  p_advertiser_id := NULL,
  p_advertiser_ids := NULL,
  p_start_date := '2026-01-20',
  p_end_date := '2026-01-28',
  p_meta_conversion_type := 'purchase'
)
LIMIT 10;
```

---

## 테스트 체크리스트

### 대시보드 (http://localhost:3000/admin/default)
- [ ] KPI 카드 (총지출, 노출수, 클릭수, 전환수)
- [ ] 일별 매출 차트
- [ ] 매체별 광고비 차트
- [ ] ROAS & 광고비 분석
- [ ] 요일별 전환수
- [ ] 성별 구매 분석
- [ ] 연령대별 성별 구매 분석
- [ ] BEST 크리에이티브 (소재 부분)
- [ ] 매체별 매출 분석

### 데이터 테이블 (http://localhost:3000/admin/data-tables)
- [ ] 계층별 광고 요약 - 캠페인 탭
- [ ] 계층별 광고 요약 - 광고그룹 탭
- [ ] 계층별 광고 요약 - 광고 탭
- [ ] 매체별 ROAS 분석

### 테스트 시나리오
1. 날짜를 **3개월 이상**으로 설정
2. 각 차트/테이블에서 데이터 정상 표시 확인
3. F12 → Console 탭에서 에러 없는지 확인

---

## 주요 이점

### 1. 성능 향상
- **변경 전**: 13,500행 조회 시도 → 1000행만 조회 (불완전)
- **변경 후**: 집계된 결과만 반환 (예: 90일 = 90행)

### 2. 데이터 정확성
- 모든 데이터를 집계에 포함
- 1000행 제한에 걸리지 않음

### 3. 유지보수성
- SQL 함수로 집계 로직 중앙화
- 프론트엔드 코드 간소화

---

## 참고 사항

### Meta 전환 타입 처리
- 광고주마다 `meta_conversion_type` 설정이 다름
- `purchase` (구매) vs `complete_registration` (회원가입)
- SQL 함수에서 `CASE`문으로 분기 처리

### NULL 처리
- `COALESCE`로 NULL → 0 변환
- 안전한 숫자 계산 보장

### 삭제된 데이터
- `deleted_at IS NULL` 조건으로 제외
- 소프트 삭제 지원

---

## 파일 목록

### 생성/수정된 파일
1. `database/migrations/add_aggregation_functions.sql` (생성)
2. `database/migrations/test_functions.sql` (생성)
3. `src/services/supabaseService.js` (수정 - 15개 함수)
4. `src/views/admin/default/components/GenderPurchasePie.js` (수정)
5. `src/views/admin/default/components/AgeGenderPurchase.js` (수정)

---

## 문제 해결 기록

### 발생한 문제
1. ~~요일별 전환수 안 나옴~~ → `get_weekday_aggregated` 함수 추가로 해결
2. ~~소재 부분 전환수 안 나옴~~ → `get_creative_aggregated` 함수 추가로 해결
3. ~~성별 구매 분석 이상함~~ → `get_gender_aggregated`, `get_age_gender_aggregated` 함수 추가로 해결
4. ~~계층별 광고 요약 집계 안 맞음~~ → `get_campaign_aggregated`, `get_ad_group_aggregated`, `get_ad_aggregated` 함수 추가로 해결
5. ~~매체별 ROAS 분석 안 맞음~~ → `getMediaROASAnalysis` 함수를 RPC로 변환하여 해결

---

## 완료 상태

✅ **모든 작업 완료**
- 12개 SQL 함수 생성 완료
- 15개 프론트엔드 함수 RPC 변환 완료
- 2개 컴포넌트 직접 수정 완료
- 브라우저 테스트 대기 중

---

## 다음 단계

1. 브라우저에서 실제 데이터 확인
2. 3개월 이상 날짜로 테스트
3. 에러 발생 시 Console에서 확인 후 추가 수정
