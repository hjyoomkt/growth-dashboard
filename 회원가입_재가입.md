# 회원가입 및 재가입 문제 해결 가이드

## 문제 상황

**증상**: 탈퇴한 회원이 같은 이메일로 재가입 시도 시 다음 오류 발생
- `"User already registered"` (Supabase Auth API)
- `"중복 키 값이 고유한 제약 조건 'users_email_key'를 위반합니다"` (PostgreSQL)

**비즈니스 요구사항**:
- 회원가입은 초대 코드로만 진행
- 초대 코드에는 에이전시/브랜드 정보가 매핑됨
- 탈퇴 후 같은 이메일로 재가입 필수
- **회원가입 로직 변경 금지**

---

## 근본 원인

### 1. 탈퇴 로직의 문제점

기존 `delete-user` Edge Function은 단순히 `deleteUser()`와 `DELETE FROM users`를 호출했으나:

**auth.users 테이블**:
- Hard Delete 시도가 실패하거나 Soft Delete로 전환됨
- Auth 서비스가 이메일을 캐시에 유지
- 재가입 시 "User already registered" 오류

**users 테이블**:
- DELETE 실패 시 레코드가 남음 (`deleted_at` NULL, `status` active)
- UNIQUE 제약(`users_email_key`)으로 인해 재가입 차단
- 재가입 시 "중복 키 값이 고유한 제약 조건 위반" 오류

### 2. 검증 결과

**SQL 조회**:
```sql
-- users 테이블에 탈퇴한 사용자가 남아있음
SELECT id, email, deleted_at, status FROM users WHERE email = 'hjyoomkt@gmail.com';
-- 결과: deleted_at NULL, status active

-- auth.users는 삭제되었으나 Auth 서비스 캐시에 남음
SELECT id, email FROM auth.users WHERE email = 'hjyoomkt@gmail.com';
-- 결과: 0 rows (하지만 재가입 시 "User already registered")
```

---

## 해결 방법

### 핵심 아이디어: 이메일 익명화

삭제 전에 이메일을 `deleted-{user_id}@deleted.local`로 변경하여:
1. 원본 이메일 해제 → 재가입 가능
2. UNIQUE 제약 우회
3. Auth 서비스 캐시 무력화

### 수정된 탈퇴 프로세스

**파일**: `supabase/functions/delete-user/index.ts` (Line 260-316)

```typescript
// 5. 이메일 익명화 (재가입 가능하도록 원본 이메일 해제)
const anonymizedEmail = `deleted-${user_id}@deleted.local`;
console.log(`Anonymizing emails: ${userData.email} -> ${anonymizedEmail}`);

// 5-1. users 테이블 이메일 익명화
const { error: usersUpdateError } = await supabaseAdmin
  .from('users')
  .update({ email: anonymizedEmail })
  .eq('id', user_id);

if (usersUpdateError) {
  console.error('Failed to anonymize users table email:', usersUpdateError);
} else {
  console.log('✅ Users table email anonymized');
}

// 5-2. auth.users 이메일 익명화
const { error: authUpdateError } = await supabaseAdmin.auth.admin.updateUserById(
  user_id,
  { email: anonymizedEmail }
);

if (authUpdateError) {
  console.error('Failed to anonymize auth email:', authUpdateError);
} else {
  console.log('✅ Auth email anonymized');
}

// 6. auth.users에서 삭제
const { error: authDeleteError } = await supabaseAdmin.auth.admin.deleteUser(user_id);

if (authDeleteError) {
  console.error('Error deleting auth user:', authDeleteError);
  return new Response(
    JSON.stringify({ error: 'Failed to delete authentication record' }),
    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  );
}

console.log('✅ Auth user deleted successfully');

// 7. users 테이블에서 삭제 (CASCADE로 관련 데이터 자동 삭제)
const { error: userDeleteError } = await supabaseAdmin
  .from('users')
  .delete()
  .eq('id', user_id);

if (userDeleteError) {
  console.error('Error deleting user record:', userDeleteError);
  return new Response(
    JSON.stringify({ error: 'Failed to delete user record' }),
    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  );
}

console.log(`User ${userData.email} deleted successfully`);
```

---

## 배포

### Edge Function 배포

```bash
cd "c:\Users\REON\Desktop\새 폴더\growth-dashboard"
SUPABASE_ACCESS_TOKEN=토큰정보 npx supabase@latest functions deploy delete-user --project-ref qdzdyoqtzkfpcogecyar
```

**배포 확인**:
- Dashboard: https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar/functions
- Logs: Dashboard → Functions → delete-user → Logs

---

## 기존 문제 계정 정리

### 1. 문제 계정 확인 및 삭제

**Supabase Dashboard → SQL Editor**에서 실행:

```sql
-- 1. 삭제할 계정 확인
SELECT id, email, deleted_at, status, created_at
FROM users
WHERE email IN (
  'hjyoomkt@gmail.com',
  'test05@example.com',
  'test06@example.com',
  'test08@example.com',
  'test10@example.com',
  'test13@example.com'
);

-- 2. users 테이블에서 삭제
DELETE FROM users
WHERE email IN (
  'hjyoomkt@gmail.com',
  'test05@example.com',
  'test06@example.com',
  'test08@example.com',
  'test10@example.com',
  'test13@example.com'
);

-- 3. 삭제 확인
SELECT id, email FROM users
WHERE email IN (
  'hjyoomkt@gmail.com',
  'test05@example.com',
  'test06@example.com',
  'test08@example.com',
  'test10@example.com',
  'test13@example.com'
);
-- 예상 결과: 0 rows
```

### 2. auth.users 정리 (필요시)

```sql
-- auth.users 확인
SELECT id, email, deleted_at FROM auth.users
WHERE email IN (
  'hjyoomkt@gmail.com',
  'test05@example.com',
  'test06@example.com',
  'test08@example.com',
  'test10@example.com',
  'test13@example.com'
);
```

**남아있는 경우**:
- Supabase Dashboard → Authentication → Users
- 해당 사용자 찾아서 수동 삭제

---

## 테스트 절차

### 1. 새 테스트 계정 생성
1. 초대 코드 발급
2. 테스트 이메일로 회원가입

### 2. 탈퇴 실행
1. 애플리케이션에서 계정 탈퇴
2. Edge Function 로그 확인:
   - `✅ Users table email anonymized`
   - `✅ Auth email anonymized`
   - `✅ Auth user deleted successfully`

### 3. SQL 검증

```sql
-- auth.users 확인 (0 rows 예상)
SELECT id, email, deleted_at FROM auth.users WHERE email = '테스트이메일@example.com';

-- users 테이블 확인 (0 rows 예상)
SELECT id, email FROM users WHERE email = '테스트이메일@example.com';

-- 익명화된 이메일 확인 (탈퇴 직후라면 1 row, 삭제 완료되면 0 rows)
SELECT id, email FROM users WHERE email LIKE 'deleted-%@deleted.local';
```

### 4. 재가입 테스트
1. 새 초대 코드 발급 (같은 이메일로)
2. 재가입 진행
3. **예상 결과**: 성공

---

## 회원가입 플로우

### 초대 코드 기반 가입

**변경 없음** - 기존 로직 그대로 유지

1. 관리자가 초대 코드 발급
2. 초대 코드에는 에이전시/브랜드 정보 매핑
3. 사용자가 초대 코드 + 이메일 + 비밀번호로 가입
4. Supabase Auth에서 계정 생성
5. `users` 테이블에 사용자 정보 저장

**이메일 중복 체크**:
- Supabase Auth: 자동으로 이메일 중복 체크
- `users` 테이블: `users_email_key` UNIQUE 제약으로 중복 방지
- **탈퇴 시 이메일 익명화로 재가입 가능**

---

## 주요 변경 사항 요약

### 변경된 파일
- `supabase/functions/delete-user/index.ts` (Line 260-316)

### 변경 내용
1. **이메일 익명화 추가**:
   - users 테이블: `UPDATE users SET email = 'deleted-{user_id}@deleted.local'`
   - auth.users: `updateUserById(user_id, { email: anonymizedEmail })`

2. **삭제 순서**:
   - 이메일 익명화 (users)
   - 이메일 익명화 (auth.users)
   - auth.users 삭제
   - users 테이블 삭제 (CASCADE)

### 장점
- 원본 이메일 즉시 해제 → 재가입 가능
- UNIQUE 제약 우회
- Auth 서비스 캐시 무력화
- 회원가입 로직 변경 불필요

---

## 문제 해결 프로세스 (참고)

### 1. 초기 증상
- "User already registered" 오류
- 재가입 불가

### 2. 진단
- SQL로 실제 데이터베이스 상태 확인
- Network 탭에서 API 응답 분석
- auth.users와 users 테이블 모두 확인

### 3. 근본 원인 발견
- users 테이블 삭제 실패 (레코드 남음)
- auth.users Auth 서비스 캐시 문제

### 4. 해결책 구현
- 이메일 익명화 패턴 적용
- Edge Function 수정
- 배포 및 테스트

### 5. 결과
- 탈퇴 후 재가입 가능
- 기존 회원가입 로직 변경 없음

---

## 참고 자료

- [Supabase Auth - Delete User](https://supabase.com/docs/reference/javascript/auth-admin-deleteuser)
- [Supabase Soft Delete Discussion](https://github.com/orgs/supabase/discussions/21274)
- [Trigger Function for Delete](https://medium.com/@wdedweliwaththa/supabase-trigger-function-to-delete-and-soft-delete-auth-users-and-profiles-8d9908d1c6b3)

---

## 추가 고려사항

### 1. 탈퇴 로그 보존
- `user_deletion_log` 테이블에 탈퇴 정보 저장
- 감사 추적 및 복구용

### 2. CASCADE 삭제
- users 테이블 삭제 시 관련 데이터 자동 삭제
- `user_advertisers`, `api_tokens` 등

### 3. advertiser_admin 권한 이전
- advertiser_admin 탈퇴 시 `new_owner_id` 필수
- 소유권 이전 후 탈퇴 진행

### 4. Master 계정 보호
- Master 계정은 삭제 불가
- 권한 계층 기반 삭제 제어

---

**작성일**: 2026-01-28
**상태**: ✅ 배포 완료, 테스트 대기 중
