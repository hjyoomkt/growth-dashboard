# 구글 애즈 OAuth 연동 완료 (2026-01-19)

## ✅ 최종 완료 상태

**Google OAuth 연결이 정상 작동합니다.**
- Vault 의존성 제거 완료
- pgcrypto 암호화 방식으로 토큰 저장
- Meta Ads는 기존 Vault 방식 유지 (영향 없음)

---

## 핵심 시스템 구조

### 1. OAuth 인증 흐름

```
사용자 → "Google 계정 연결" 클릭
  ↓
oauth-initiate Edge Function 호출
  ↓
Google OAuth 팝업 열림
  ↓
oauth-callback Edge Function 처리
  ↓
Refresh Token 암호화 저장 (pgcrypto)
  ↓
팝업에서 부모 창으로 토큰 전달 (postMessage)
  ↓
폼에 자동 입력 완료
```

### 2. 토큰 저장 방식

**조직 GCP 설정 (장기 저장)**
- 방식: pgcrypto (PGP 대칭키 암호화)
- 테이블: `organizations`
- 컬럼: `google_*_encrypted` (TEXT)
- 키: `'your-encryption-key-change-this-in-production'`
- 파라미터: client_id, client_secret, developer_token, mcc_id

**OAuth 세션 (임시, 15분)**
- 방식: 평문 저장 (15분 후 자동 삭제)
- 테이블: `oauth_authorization_sessions`
- 컬럼: `client_id` (TEXT), `client_secret` (TEXT)

**OAuth 토큰 (장기 저장)**
- 방식: pgcrypto (Base64 인코딩)
- 테이블: `integrations`
- 컬럼: `oauth_access_token_encrypted` (TEXT), `oauth_refresh_token_encrypted` (TEXT)
- 플랫폼: Google Ads만 (Meta Ads는 Vault 사용)

---

## 주요 파일 및 코드

### Edge Functions

**oauth-initiate** (`supabase/functions/oauth-initiate/index.ts`)
- OAuth URL 생성
- 세션 저장 (client_secret 평문 저장, 15분 TTL)
- 251-280번 줄: Vault 제거, 직접 저장

**oauth-callback** (`supabase/functions/oauth-callback/index.ts`)
- Authorization code → Access/Refresh Token 교환
- 플랫폼별 토큰 저장 분기:
  - Google Ads: pgcrypto 암호화 (188-204번 줄)
  - Meta Ads: Vault 저장 (206-238번 줄)
- 140-146번 줄: client_secret 세션에서 직접 조회

**배포 명령어**
```bash
cd /Users/reon/Desktop/개발/growth-dashboard
supabase functions deploy oauth-initiate --no-verify-jwt
supabase functions deploy oauth-callback --no-verify-jwt
```

### 프론트엔드

**APITokenTable.js** (`src/views/superadmin/api-management/components/APITokenTable.js`)
- 416-567번 줄: `handleGoogleOAuthConnect` - OAuth 팝업 처리
- 517-567번 줄: postMessage 핸들러 - 팝업에서 토큰 수신
- 893-904번 줄: Manager Account ID를 조직 GCP에서 자동 가져오기
- 906-927번 줄: 필드 검증 (managerAccountId 추가)

**oauth-callback.html** (`public/oauth-callback.html`)
- OAuth 완료 후 팝업에서 부모 창으로 토큰 전달
- postMessage API 사용

### 데이터베이스

**주요 함수들** (Supabase SQL Editor에서 실행 완료)

```sql
-- 1. OAuth 토큰 암호화 (Base64)
CREATE FUNCTION encrypt_oauth_tokens(
  p_access_token TEXT,
  p_refresh_token TEXT DEFAULT NULL,
  p_encryption_key TEXT DEFAULT 'your-encryption-key-change-this-in-production'
)
RETURNS TABLE(
  access_token_encrypted TEXT,
  refresh_token_encrypted TEXT
)
-- 반환: Base64로 인코딩된 암호화 토큰

-- 2. 조직 GCP 설정 저장 (4개 파라미터)
CREATE FUNCTION save_organization_gcp_credentials(
  org_id UUID,
  p_client_id TEXT DEFAULT NULL,
  p_client_secret TEXT DEFAULT NULL,
  p_developer_token TEXT DEFAULT NULL,
  p_mcc_id TEXT DEFAULT NULL
)
RETURNS JSONB

-- 3. 조직 GCP 미리보기 (마스킹)
CREATE FUNCTION get_organization_gcp_preview(org_id UUID)
RETURNS TABLE(
  client_id_preview TEXT,
  client_secret_preview TEXT,
  developer_token_preview TEXT,
  mcc_id_preview TEXT
)

-- 4. 조직 GCP 전체 값 조회 (OAuth용)
CREATE FUNCTION get_organization_gcp_credentials(org_id UUID)
RETURNS TABLE(
  client_id TEXT,
  client_secret TEXT,
  developer_token TEXT,
  mcc_id TEXT
)
```

**실제 사용 중인 SQL 파일**
- `/Users/reon/Desktop/개발/growth-dashboard/restore_pgcrypto_with_mcc.sql`

**스키마 변경**
```sql
-- oauth_authorization_sessions 테이블
ALTER TABLE oauth_authorization_sessions
ADD COLUMN client_secret TEXT;

-- integrations 테이블
ALTER TABLE integrations
ADD COLUMN oauth_access_token_encrypted TEXT,
ADD COLUMN oauth_refresh_token_encrypted TEXT;
```

---

## 토큰 복호화 및 검증

### 저장된 토큰 확인
```sql
-- 1. 통합 정보 조회
SELECT
  id,
  platform,
  integration_type,
  oauth_access_token_encrypted IS NOT NULL as has_access_token,
  oauth_refresh_token_encrypted IS NOT NULL as has_refresh_token,
  LENGTH(oauth_access_token_encrypted) as access_token_length,
  LENGTH(oauth_refresh_token_encrypted) as refresh_token_length,
  oauth_token_expires_at,
  status,
  created_at
FROM integrations
WHERE platform = 'Google Ads'
  AND integration_type = 'oauth'
ORDER BY created_at DESC
LIMIT 1;

-- 2. 토큰 복호화
SELECT
  id,
  platform,
  pgp_sym_decrypt(decode(oauth_access_token_encrypted, 'base64'), 'your-encryption-key-change-this-in-production') as access_token,
  pgp_sym_decrypt(decode(oauth_refresh_token_encrypted, 'base64'), 'your-encryption-key-change-this-in-production') as refresh_token
FROM integrations
WHERE id = '<integration_id>';
```

**정상 토큰 형식**
- Access Token: `ya29.a0AUMWg_J6...` (시작)
- Refresh Token: `1//0eFJE5s8z4...` (시작)

---

## 사용 방법

### 1단계: 조직 GCP 설정
1. `/superadmin/default` 접속
2. Client ID, Client Secret, Developer Token, MCC ID 입력
3. 저장

### 2단계: OAuth 연결
1. `/superadmin/api-management` 접속
2. "새 토큰 추가" → Google Ads 선택
3. 브랜드 선택
4. "대행사 GCP 사용" 선택
5. "Google 계정 연결" 클릭
6. OAuth 팝업에서 Google 계정 선택
7. Refresh Token 자동 입력 확인

### 3단계: 나머지 정보 입력
1. Customer ID 입력
2. Manager Account ID (자동 입력됨, 조직 GCP의 MCC ID)
3. 전환 액션 선택
4. 계정 설명 입력 (선택)
5. 저장

---

## 문제 해결 히스토리

### 초기 문제: Vault 테이블 없음
- 에러: `Could not find the table 'public.vault.secrets'`
- 원인: Supabase Vault 확장 미활성화
- 해결: Vault 의존성 제거, pgcrypto 사용

### 해결 과정
1. `oauth_authorization_sessions.client_secret` 컬럼 추가 (평문)
2. `oauth-initiate` Vault 제거, 직접 저장
3. `oauth-callback` Vault 조회 제거, 세션에서 직접 조회
4. `integrations` 테이블에 암호화 컬럼 추가 (TEXT)
5. `encrypt_oauth_tokens` 함수 생성 (Base64 인코딩)
6. Manager Account ID 자동 입력 로직 추가
7. 필드 검증 수정

---

## DEPRECATED 파일들 (사용 안함)

**마이그레이션 파일**
- `supabase/migrations/018_organization_gcp_settings.sql` (Vault 방식)
- `supabase/migrations/033_add_mcc_id_support.sql` (Vault 방식)

**유틸 함수**
- `src/utils/googleOAuth.js` (LEGACY, Edge Function 사용 중)

---

## 향후 개선 사항

### 1. 조직 단위 토큰 공유 (선택)
- 같은 조직의 다른 직원이 Google 계정 연결 시
- 기존 Refresh Token 자동 재사용 (OAuth 재인증 불필요)
- 보안: 조직 격리 필요 (RLS 정책)

### 2. 암호화 키 관리
- 현재: 하드코딩 (`'your-encryption-key-change-this-in-production'`)
- 개선: 환경변수 또는 Secrets Manager 사용

### 3. Access Token 자동 갱신
- Refresh Token으로 만료 시 자동 재발급
- 현재는 데이터 수집 시 구현됨

---

## 주요 경로 정리

```
/Users/reon/Desktop/개발/growth-dashboard/
├── supabase/functions/
│   ├── oauth-initiate/index.ts          ✅ 배포 완료
│   ├── oauth-callback/index.ts          ✅ 배포 완료
│   └── save-organization-gcp/index.ts   ✅ 배포 완료
├── public/
│   └── oauth-callback.html              ✅ 생성 완료
├── src/views/
│   ├── superadmin/default/index.jsx     ✅ 수정 완료
│   └── superadmin/api-management/components/
│       └── APITokenTable.js             ✅ 수정 완료
└── restore_pgcrypto_with_mcc.sql        ✅ 실행 완료
```

---

## 검증 완료 사항

- ✅ OAuth 팝업 정상 작동
- ✅ Refresh Token 암호화 저장 (Base64)
- ✅ 토큰 복호화 검증 완료
- ✅ Manager Account ID 자동 입력
- ✅ Meta Ads 영향 없음 (Vault 유지)
- ✅ 조직 GCP 설정 저장/조회 정상

---

## 문의 및 참고

**Supabase 정보**
- Project URL: `https://qdzdyoqtzkfpcogecyar.supabase.co`
- Anon Key: `.env` 파일 참고

**Apps Script 참고 코드**
- `/Users/reon/Desktop/개발/앱스스크립트api/Google_auto_v1.0.js`
- `AutoGetAccessToken()`: Refresh Token으로 Access Token 발급 (51-87줄)
