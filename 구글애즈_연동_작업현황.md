# êµ¬ê¸€ ì• ì¦ˆ API ì—°ë™ ì‘ì—… í˜„í™©

ì‘ì„±ì¼: 2026-01-18

## ì‘ì—… ëª©í‘œ
`http://localhost:3000/superadmin/default`ì—ì„œ GCP ì„¤ì •ì„ ì…ë ¥í•˜ë©´, `http://localhost:3000/superadmin/api-management`ì˜ í† í° ì¶”ê°€ì—ì„œ Google Ads ì„ íƒ ì‹œ í•´ë‹¹ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ë„ë¡ í•˜ëŠ” ì‹œìŠ¤í…œ ì™„ì„±

---

## ì™„ë£Œëœ ì‘ì—…

### 1. Edge Function ìƒì„± ë° ë°°í¬ âœ…
**íŒŒì¼**:
- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/google-oauth-callback/index.ts`
- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/resolve-access-token/index.ts`

**ë°°í¬ ìƒíƒœ**: âœ… ì™„ë£Œ
```bash
npx supabase functions deploy google-oauth-callback
npx supabase functions deploy resolve-access-token
```

**ê¸°ëŠ¥**:
- `google-oauth-callback`: Google OAuth2 ì¸ì¦ í›„ Refresh Token ë°œê¸‰ (í˜„ì¬ ë„ë©”ì¸ ì—†ì–´ì„œ ì‹¤ì œ ì‚¬ìš© ë¶ˆê°€)
- `resolve-access-token`: Refresh Tokenìœ¼ë¡œ Access Token ì¬ë°œê¸‰

### 2. OAuth URL ìƒì„± ìœ í‹¸ í•¨ìˆ˜ âœ…
**íŒŒì¼**: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/utils/googleOAuth.js`

**ê¸°ëŠ¥**: Google OAuth URL ìƒì„± (ì‹¤ì œ ë„ë©”ì¸ í•„ìš”)

### 3. API í† í° í…Œì´ë¸” UI ìˆ˜ì • âœ…
**íŒŒì¼**: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/api-management/components/APITokenTable.js`

**ë³€ê²½ì‚¬í•­**:
- `generateGoogleOAuthUrl` import ì¶”ê°€ (line 63)
- `handleGoogleOAuthConnect` í•¨ìˆ˜ ì‹¤ì œ OAuth í”Œë¡œìš°ë¡œ êµì²´ (line 403-477)

---

## ì™„ë£Œëœ ì‘ì—… (2026-01-18)

### 4. GCP ì„¤ì • ì €ì¥/ì¡°íšŒ ê¸°ëŠ¥ êµ¬í˜„ âœ…

**êµ¬í˜„ ë‚´ìš©**:
1. PostgreSQL pgcrypto ì‚¬ìš© (`pgp_sym_encrypt`/`pgp_sym_decrypt`)
2. DB Functionìœ¼ë¡œ ì•”í˜¸í™” ì €ì¥ ë° ë³µí˜¸í™” ì¡°íšŒ
3. UIì—ì„œ ë¶€ë¶„ ë§ˆìŠ¤í‚¹ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ

**ì ìš©ëœ íŒŒì¼**:
- DB Function SQL: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/fix_save_function_delete.sql` (ì‹¤í–‰ ì™„ë£Œ)
- DB Function SQL: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/add_preview_function.sql` (ì‹¤í–‰ ì™„ë£Œ)
- DB Function SQL: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/secure_gcp_check.sql` (ì‹¤í–‰ ì™„ë£Œ)
- Edge Function: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/save-organization-gcp/index.ts` (ë°°í¬ ì™„ë£Œ)
- UI: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/default/index.jsx`
- UI: `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/api-management/components/APITokenTable.js`

**DB Function ëª©ë¡**:
```sql
save_organization_gcp_credentials(org_id, p_client_id, p_client_secret, p_developer_token)
get_organization_gcp_preview(org_id) â†’ { client_id_preview, client_secret_preview, developer_token_preview }
check_organization_gcp_credentials(org_id) â†’ { has_credentials, has_developer_token }
_internal_get_organization_gcp_credentials(org_id) â†’ { client_id, client_secret, developer_token }
```

---

## ğŸš¨ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì˜¤ë¥˜ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)

### ë¬¸ì œ: Developer Token ì‚­ì œ ì‹œ ëª¨ë“  GCP ì„¤ì •ì´ ì‚­ì œë¨

**ì¦ìƒ**:
- `/superadmin/default`ì—ì„œ Developer Token í•„ë“œë§Œ ì§€ìš°ê³  ì €ì¥
- ì˜ˆìƒ: Developer Tokenë§Œ NULLë¡œ ì„¤ì •
- ì‹¤ì œ: Client ID, Client Secret, Developer Token ëª¨ë‘ NULLë¡œ ì„¤ì •ë¨

**ë¡œê·¸ ë¶„ì„**:
```javascript
[GCP Settings] Save payload:
{
  organization_id: '53bbd84f-25c4-4808-bc5e-58da08ba5277',
  client_id: 'null',           // ë§ˆìŠ¤í‚¹ ê°’ì¸ë° null ì „ì†¡
  client_secret: 'null',        // ë§ˆìŠ¤í‚¹ ê°’ì¸ë° null ì „ì†¡
  developer_token: 'EMPTY_STRING'  // ì •ìƒ (ì‚­ì œ ì˜ë„)
}
```

**ì›ì¸ íŒŒì•… í•„ìš”**:
1. í˜ì´ì§€ ë¡œë“œ ì‹œ ë§ˆìŠ¤í‚¹ ê°’ì´ stateì— ì œëŒ€ë¡œ ë“¤ì–´ê°€ëŠ”ì§€ í™•ì¸
2. Developer Tokenë§Œ ì§€ì› ì„ ë•Œ ë‹¤ë¥¸ í•„ë“œê°€ ì™œ ë¹ˆ ë¬¸ìì—´ì´ ë˜ëŠ”ì§€ í™•ì¸

**ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ë¨**:
- `src/views/superadmin/default/index.jsx` ë¼ì¸ 120: `[GCP Settings] Setting masked values:` (í˜ì´ì§€ ë¡œë“œ ì‹œ)
- ë¼ì¸ 177-182: `[GCP Settings] Save payload:` (ì €ì¥ ì‹œ)

**í™•ì¸í•´ì•¼ í•  ì‚¬í•­**:
1. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ `[GCP Settings] Setting masked values:` ë¡œê·¸ í™•ì¸
   - `clientId`, `clientSecret`, `developerToken`ì— ë§ˆìŠ¤í‚¹ ê°’ì´ ì œëŒ€ë¡œ ë“¤ì–´ê°€ëŠ”ì§€
2. Developer Token í•„ë“œë§Œ ì§€ìš°ê³  ì €ì¥ ì§ì „ `[GCP Settings] Save payload:` ë¡œê·¸ í™•ì¸
   - `client_id`, `client_secret`ê°€ ì™œ `"null"`ì¸ì§€ (ë§ˆìŠ¤í‚¹ ê°’ì´ì–´ì•¼ í•¨)
3. ì…ë ¥ í•„ë“œ í´ë¦­ ì—¬ë¶€ í™•ì¸
   - Client ID, Client Secret í•„ë“œë¥¼ í´ë¦­í–ˆëŠ”ì§€
   - í´ë¦­í•˜ë©´ `handleInputFocus`ê°€ í˜¸ì¶œë˜ì–´ ë¹ˆ ë¬¸ìì—´ë¡œ ì´ˆê¸°í™”ë¨

**ì˜ì‹¬ í¬ì¸íŠ¸**:
- í˜ì´ì§€ ë¡œë“œ í›„ ë¯¸ë¦¬ë³´ê¸° ì¡°íšŒ ì‹œ Developer Tokenì´ NULLì´ë©´ ë¹ˆ ë¬¸ìì—´ `''` ë°˜í™˜
- ì´í›„ ë Œë”ë§ ê³¼ì •ì—ì„œ ëª¨ë“  í•„ë“œê°€ ë¹ˆ ë¬¸ìì—´ë¡œ ì´ˆê¸°í™”ë˜ëŠ” ë²„ê·¸ ê°€ëŠ¥ì„±

**ë‹¤ìŒ ì‘ì—…ì ì‹œì‘ ê°€ì´ë“œ**:

1. **ë¨¼ì € í™•ì¸í•  íŒŒì¼**:
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/default/index.jsx`
   - ë¼ì¸ 120: `[GCP Settings] Setting masked values:` ë¡œê·¸
   - ë¼ì¸ 177-182: `[GCP Settings] Save payload:` ë¡œê·¸

2. **ì¬í˜„ ë°©ë²•**:
   ```bash
   # ê°œë°œ ì„œë²„ ì‹¤í–‰
   npm start

   # ë¸Œë¼ìš°ì €ì—ì„œ
   http://localhost:3000/superadmin/default

   # ê°œë°œì ë„êµ¬ ì½˜ì†” ì—´ê¸°
   # í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ í™•ì¸
   # Developer Token í•„ë“œ ê°’ ì§€ìš°ê¸°
   # ì €ì¥ ë²„íŠ¼ í´ë¦­ ì „ ì½˜ì†” ë¡œê·¸ í™•ì¸
   ```

3. **ë¡œê·¸ ë¶„ì„**:
   - `[GCP Settings] Setting masked values:` â†’ ë§ˆìŠ¤í‚¹ ê°’ ì œëŒ€ë¡œ ë“¤ì–´ê°”ëŠ”ì§€
   - `[GCP Settings] Save payload:` â†’ `client_id`, `client_secret`ê°€ ì™œ `"null"`ì¸ì§€

4. **ì˜ì‹¬ ì½”ë“œ ìœ„ì¹˜**:
   - `index.jsx` ë¼ì¸ 113-122: `fetchGcpSettings` - í˜ì´ì§€ ë¡œë“œ ì‹œ state ì„¤ì •
   - ë¼ì¸ 228-234: `handleInputFocus` - í•„ë“œ í´ë¦­ ì‹œ ë§ˆìŠ¤í‚¹ í•´ì œ
   - ë¼ì¸ 170-194: `handleSaveGcpSettings` - ì €ì¥ ë¡œì§

5. **ì˜ˆìƒ ì›ì¸**:
   - í˜ì´ì§€ ë¡œë“œ í›„ stateê°€ ë¹ˆ ë¬¸ìì—´ë¡œ ë®ì–´ì”Œì›Œì§
   - ë˜ëŠ” ë Œë”ë§ ì¤‘ `onChange` ì´ë²¤íŠ¸ê°€ ë°œìƒí•´ì„œ state ì´ˆê¸°í™”ë¨

6. **í•´ê²° ë°©í–¥**:
   - state ë³€ê²½ ë¡œê·¸ë¥¼ ë” ì¶”ê°€í•´ì„œ ì–¸ì œ ë¹ˆ ë¬¸ìì—´ì´ ë˜ëŠ”ì§€ ì¶”ì 
   - `handleInputFocus` í˜¸ì¶œ ë¡œê·¸ í™•ì¸ (ì´ë¯¸ ì¶”ê°€ë¨)
   - í•„ìš” ì‹œ React DevToolsë¡œ state ë³€ê²½ ì¶”ì 

7. **ê²€ì¦ ë°©ë²•**:
   ```sql
   -- Developer Tokenë§Œ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
   SELECT
     google_client_id_encrypted IS NOT NULL as has_client_id,
     google_client_secret_encrypted IS NOT NULL as has_client_secret,
     google_developer_token_encrypted IS NOT NULL as has_developer_token
   FROM organizations
   WHERE id = '53bbd84f-25c4-4808-bc5e-58da08ba5277';

   -- ê²°ê³¼: has_client_id=true, has_client_secret=true, has_developer_token=false ì—¬ì•¼ ì •ìƒ
   ```

---

## í–¥í›„ ì‘ì—…

### 1. Refresh Token ìˆ˜ë™ ì…ë ¥ ë°©ì‹ ì‚¬ìš©
**ì´ìœ **: localhostëŠ” Google OAuth Redirect URIë¡œ ë“±ë¡ ë¶ˆê°€

**ë°©ë²•**:
1. Google OAuth Playground ì‚¬ìš©
2. Scope: `https://www.googleapis.com/auth/adwords`
3. ë°œê¸‰ë°›ì€ Refresh Tokenì„ `/superadmin/api-management`ì—ì„œ ìˆ˜ë™ ì…ë ¥

### 2. ë°ì´í„° ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
**í™•ì¸ ì‚¬í•­**:
- Initial Collection ì‹¤í–‰
- `collection_jobs` í…Œì´ë¸”ì—ì„œ ì§„í–‰ ìƒí™© í™•ì¸
- `ad_performance` í…Œì´ë¸”ì—ì„œ ë°ì´í„° í™•ì¸

---

## ì£¼ìš” íŒŒì¼ ê²½ë¡œ ì •ë¦¬

### ì‹ ê·œ ìƒì„± (ì™„ë£Œ)
```
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/google-oauth-callback/index.ts
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/resolve-access-token/index.ts
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/utils/googleOAuth.js
```

### ìˆ˜ì • ì™„ë£Œ
```
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/api-management/components/APITokenTable.js
```

### GCP ì €ì¥ ê¸°ëŠ¥ ê´€ë ¨ (ìˆ˜ì • ì™„ë£Œ)
```
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/save-organization-gcp/index.ts (DB Function í˜¸ì¶œ)
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/default/index.jsx (ë§ˆìŠ¤í‚¹ ë¯¸ë¦¬ë³´ê¸°)
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/api-management/components/APITokenTable.js (ë§ˆìŠ¤í‚¹ ë¯¸ë¦¬ë³´ê¸°)
```

### DB Function
```sql
-- organizations í…Œì´ë¸” ì €ì¥
save_organization_gcp_credentials(org_id, client_id, client_secret, developer_token)

-- ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ë³´ì•ˆ)
check_organization_gcp_credentials(org_id) â†’ { has_credentials, has_developer_token }

-- ë¶€ë¶„ ë§ˆìŠ¤í‚¹ ë¯¸ë¦¬ë³´ê¸°
get_organization_gcp_preview(org_id) â†’ { client_id_preview, client_secret_preview, developer_token_preview }

-- ì „ì²´ ê°’ ì¡°íšŒ (ë‚´ë¶€ ì „ìš©)
_internal_get_organization_gcp_credentials(org_id) â†’ { client_id, client_secret, developer_token }
```

### ê¸°ì¡´ ì™„ì„± (ì°¸ê³ ìš©)
```
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/_shared/collectors/google.ts
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/collect-ad-data/index.ts
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/daily-scheduler/index.ts
/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/migrations/008_scheduler_final.sql
```

---

## ì°¸ê³  ìë£Œ

### Apps Script OAuth ì°¸ê³  ì½”ë“œ
**ìœ„ì¹˜**: `/Users/reon/Desktop/ê°œë°œ/ì•±ìŠ¤ìŠ¤í¬ë¦½íŠ¸api/Google_auto_v1.0.js`

**ì£¼ìš” í•¨ìˆ˜**:
- `AutoGetAccessToken()`: Refresh Tokenìœ¼ë¡œ Access Token ë°œê¸‰ (line 51-87)
- Google Ads API v22 í˜¸ì¶œ ë¡œì§ (line 306-880)

### Supabase ì •ë³´
- **Project URL**: `https://qdzdyoqtzkfpcogecyar.supabase.co`
- **Anon Key**: `.env` íŒŒì¼ ì°¸ê³ 

---

## ë‹¤ìŒ ì‘ì—…ìë¥¼ ìœ„í•œ ê°€ì´ë“œ

### 1ë‹¨ê³„: GCP ì„¤ì • ì €ì¥
1. ê°œë°œ ì„œë²„ ì‹¤í–‰: `npm start`
2. `http://localhost:3000/superadmin/default` ì ‘ì†
3. GCP ì„¤ì • ì…ë ¥:
   - Client ID
   - Client Secret
   - Developer Token (ì„ íƒ)
4. ì €ì¥ ë²„íŠ¼ í´ë¦­
5. "ì €ì¥ ì™„ë£Œ" ë©”ì‹œì§€ í™•ì¸

### 2ë‹¨ê³„: ì €ì¥ëœ ì„¤ì • í™•ì¸
**ë°©ë²• 1**: UIì—ì„œ í™•ì¸ (ê¶Œì¥)
1. `http://localhost:3000/superadmin/default` í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
2. ë¸Œë¼ìš°ì € Network íƒ­ì—ì„œ `get_organization_gcp_preview` ì‘ë‹µ í™•ì¸
3. ë§ˆìŠ¤í‚¹ëœ ê°’ í‘œì‹œ í™•ì¸ (ì˜ˆ: `3380â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢e44r`)

**ë°©ë²• 2**: SQLë¡œ í™•ì¸
```sql
-- ë¶€ë¶„ ë§ˆìŠ¤í‚¹ëœ ë¯¸ë¦¬ë³´ê¸°
SELECT * FROM get_organization_gcp_preview('53bbd84f-25c4-4808-bc5e-58da08ba5277');
```

### 3ë‹¨ê³„: í† í° ì¶”ê°€ í…ŒìŠ¤íŠ¸
1. `/superadmin/api-management` ì ‘ì†
2. Network íƒ­ì—ì„œ `get_organization_gcp_preview` ì‘ë‹µ í™•ì¸ (ë§ˆìŠ¤í‚¹ëœ ê°’)
3. "í† í° ì¶”ê°€" â†’ "Google Ads" ì„ íƒ
4. GCP ì†ŒìŠ¤: "ëŒ€í–‰ì‚¬ GCP ì‚¬ìš©" ì„ íƒ
5. âœ“ ë§ˆìŠ¤í‚¹ëœ Client ID/Secret ìë™ í‘œì‹œ í™•ì¸
6. Customer ID, MCC ID, Refresh Tokenë§Œ ì…ë ¥
7. ì €ì¥ í…ŒìŠ¤íŠ¸ (Client ID/Secretì€ ìë™ìœ¼ë¡œ ì„œë²„ì—ì„œ ì ìš©ë¨)

### 4ë‹¨ê³„: ë°ì´í„° ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
1. Initial Collection ëª¨ë‹¬ì—ì„œ ê¸°ê°„ ì„ íƒ
2. ìˆ˜ì§‘ ì‹œì‘
3. Supabase Dashboardì—ì„œ `collection_jobs` í…Œì´ë¸” í™•ì¸
4. `ad_performance` í…Œì´ë¸”ì—ì„œ Google Ads ë°ì´í„° í™•ì¸

---

## ì£¼ì˜ì‚¬í•­

1. **OAuth ìë™ ë°œê¸‰ì€ ì‹¤ì œ ë„ë©”ì¸ í•„ìš”**
   - localhostì—ì„œëŠ” Google OAuth Redirect URI ë“±ë¡ ë¶ˆê°€
   - ë‹¹ë¶„ê°„ Refresh Token ìˆ˜ë™ ì…ë ¥ ë°©ì‹ ì‚¬ìš©

2. **Developer Token**
   - í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë³¸ì¸ ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥
   - í”„ë¡œë•ì…˜: Google ìŠ¹ì¸ í•„ìš”

3. **MCC ê³„ì •**
   - Manager Account ì‚¬ìš© ì‹œ `login-customer-id` í—¤ë” í•„ìˆ˜
   - ì´ë¯¸ `collect-ad-data`ì— êµ¬í˜„ë¨

4. **Conversion Action ID**
   - Resource Name í˜•ì‹: `customers/{customer_id}/conversionActions/{conversion_action_id}`
   - ìˆ˜ì§‘ê¸°ì—ì„œ ìë™ ë³€í™˜ ì²˜ë¦¬

---

## ë¬¸ì œ ë°œìƒ ì‹œ í™•ì¸ ì‚¬í•­

### GCP ì„¤ì • ì €ì¥ ì‹¤íŒ¨
- Edge Function ë°°í¬ ì—¬ë¶€: `npx supabase functions deploy save-organization-gcp`
- DB Function ì¡´ì¬ ì—¬ë¶€: `SELECT * FROM pg_proc WHERE proname = 'save_organization_gcp_credentials';`
- pgcrypto í™•ì¥ ì„¤ì¹˜: `CREATE EXTENSION IF NOT EXISTS pgcrypto;`

### í† í° ì¶”ê°€ ì €ì¥ ì‹¤íŒ¨
- integrations í…Œì´ë¸” insert ê¶Œí•œ í™•ì¸
- RLS ì •ì±… í™•ì¸
- ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸

### ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨
- Access Token ë°œê¸‰ ì‹¤íŒ¨ â†’ Refresh Token í™•ì¸
- API ê¶Œí•œ ë¶€ì¡± â†’ Developer Token í™•ì¸
- ê³ ê° ID ì˜¤ë¥˜ â†’ Customer ID, MCC ID í™•ì¸
