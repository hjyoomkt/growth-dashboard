# 구글 애즈 토큰 조회 오류 수정 완료 (2026-01-19)

## 문제
- Google Ads 데이터 수집 실패
- 오류: "Google Ads credentials are missing"
- 오류: "Could not find the function public.vault_get_secret"

## 원인
`resolve-access-token`과 `google.ts` collector에서 존재하지 않는 Vault 함수 호출

**잘못된 코드**:
```typescript
// vault_get_secret 함수 (존재하지 않음)
await supabase.rpc('vault_get_secret', { secret_id: vaultId })

// resolve-access-token에서
await supabase.rpc('get_decrypted_token', { p_vault_id: vault_id })
```

**올바른 코드**:
```typescript
// get_decrypted_token 함수 사용
await supabase.rpc('get_decrypted_token', {
  p_api_token_id: integration_id,
  p_token_type: 'refresh_token' // 또는 'client_secret', 'developer_token'
})
```

## 수정 파일

### 1. resolve-access-token/index.ts
**위치**: `/Users/reon/Desktop/개발/growth-dashboard/supabase/functions/resolve-access-token/index.ts`

**수정 내용**:
- Google Ads (47-79줄): `p_vault_id` → `p_api_token_id` + `p_token_type`
- Meta Ads (108-122줄): 동일 수정
- Naver Ads (127-141줄): 동일 수정
- Integration 쿼리 (35줄): 불필요한 vault_id 컬럼 제거

### 2. _shared/collectors/google.ts
**위치**: `/Users/reon/Desktop/개발/growth-dashboard/supabase/functions/_shared/collectors/google.ts`

**수정 내용**:
- `getVaultSecret` → `getDecryptedToken` 함수로 교체 (278-293줄)
- Developer Token 조회 방식 변경 (14줄)
- JSON 파싱 로직 개선 (67-98줄): Pretty-printed JSON 처리

**JSON 파싱 수정**:
```typescript
// 기존: \n으로 split (실패)
const chunks = responseText.trim().split('\n')
for (const chunk of chunks) {
  JSON.parse(chunk) // 각 줄은 완전한 JSON이 아님
}

// 수정: 전체를 한번에 파싱
const jsonArray = JSON.parse(responseText) // 전체 JSON 파싱
if (Array.isArray(jsonArray)) {
  // 배열 처리
}
```

## 배포 명령어
```bash
cd /Users/reon/Desktop/개발/growth-dashboard
supabase functions deploy resolve-access-token --no-verify-jwt
supabase functions deploy collect-ad-data --no-verify-jwt
```

## 검증 완료
✅ "Google Ads credentials are missing" 오류 해결
✅ "vault_get_secret not found" 오류 해결
✅ Access Token 정상 발급 확인
✅ 데이터 수집 성공 (일반 광고)

## RPC 함수 정보
**함수**: `get_decrypted_token(p_api_token_id UUID, p_token_type TEXT)`
**정의**: `/Users/reon/Desktop/개발/growth-dashboard/supabase/migrations/014_integrations_encryption.sql` (140-176줄)

**토큰 타입**:
- `refresh_token`: Google Ads Refresh Token
- `client_secret`: OAuth Client Secret
- `developer_token`: Google Ads Developer Token
- `access_token`: Meta/Naver Access Token

**저장 위치**: `integrations` 테이블의 `*_encrypted` 컬럼 (BYTEA)

## 영향 없는 부분
- ✅ Meta Ads: 기존에 올바른 RPC 호출 사용 중 (영향 없음)
- ✅ OAuth 로그인: 별도 컬럼(`oauth_*_encrypted`) 사용 (영향 없음)
- ✅ 전환액션 조회: 프론트엔드에서 직접 토큰 전달 (영향 없음)

## P-MAX 데이터 미수집 이슈
**상태**: 일반 광고는 수집되나 P-MAX Asset Group 데이터 미수집
**위치**: `collectGoogleAssetGroups` 함수 (156-273줄)
**원인**: 미확인 (별도 조사 필요)

## 참고
- Meta Ads는 `collect-ad-data`에서 직접 RPC 호출 (368-384줄)
- `resolve-access-token` 함수를 거치지 않음
