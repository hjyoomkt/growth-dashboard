# êµ¬ê¸€ ì• ì¦ˆ ì¡°ì§ ë‹¨ìœ„ í† í° ê³µìœ  ì‘ì—… ë‚´ì—­ (2026-01-20)

## ì‘ì—… ê°œìš”

**ëª©ì **: ê°™ì€ ì¡°ì§ ë‚´ì—ì„œ ê¸°ì¡´ Google Ads Refresh Tokenì„ ì¬ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ OAuth ì¸ì¦ ë°©ì§€

**ìƒíƒœ**: ğŸ”´ **ë¯¸ì™„ë£Œ** (Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜ ë°œìƒ ì¤‘)

---

## ì™„ë£Œëœ ì‘ì—…

### 1. âœ… PostgreSQL RPC í•¨ìˆ˜ ì˜¤ë¥˜ ìˆ˜ì •

**ë¬¸ì œ**: `get_organization_google_tokens` RPC í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ì˜¤ë¥˜
```
column reference "organization_id" is ambiguous
```

**ì›ì¸**: PL/pgSQL ë³€ìˆ˜ëª… `v_org_id`ì™€ í…Œì´ë¸” ì»¬ëŸ¼ëª… `organization_id` ì¶©ëŒ

**í•´ê²°**:
- **íŒŒì¼**: `supabase/migrations/034_organization_shared_tokens.sql`
- **ìˆ˜ì •**: ë³€ìˆ˜ëª… `v_org_id` â†’ `v_current_org_id` (4ê³³)
  - 40ë²ˆì§¸ ì¤„: DECLARE ë¸”ë¡
  - 50ë²ˆì§¸ ì¤„: SELECT INTO êµ¬ë¬¸
  - 82ë²ˆì§¸ ì¤„: NULL ì²´í¬
  - 100ë²ˆì§¸ ì¤„: WHERE ì¡°ê±´
- **SQL ì¬ì‹¤í–‰**: Supabase SQL Editorì—ì„œ `#variable_conflict use_column` ì§€ì‹œì–´ ì¶”ê°€
- **ê²°ê³¼**: RPC í•¨ìˆ˜ ì •ìƒ ì‘ë™ í™•ì¸ âœ…

### 2. âœ… í† í° ì„ íƒ ì‹œ Refresh Token ìë™ì…ë ¥ ì¶”ê°€

**ë¬¸ì œ**: ê¸°ì¡´ í† í° ì„ íƒ ì‹œ Refresh Tokenì´ ìë™ìœ¼ë¡œ í•„ë“œì— ì…ë ¥ë˜ì§€ ì•ŠìŒ

**ë¶„ì„**:
- **OAuth ì„±ê³µ ì‹œ**: `oauth-callback.html`ì—ì„œ í‰ë¬¸ í† í°ì„ postMessageë¡œ ì „ë‹¬ â†’ ìë™ì…ë ¥ âœ…
- **ê¸°ì¡´ í† í° ì„ íƒ ì‹œ**: `integration_id`ë§Œ ì €ì¥í•˜ê³  í† í° ë³µí˜¸í™” ì—†ìŒ âŒ

**í•´ê²°**:
- **íŒŒì¼**: `src/views/superadmin/api-management/components/APITokenTable.js`
- **í•¨ìˆ˜**: `handleSelectToken` (657-695ë²ˆì§¸ ì¤„)
- **ìˆ˜ì • ë‚´ìš©**:
  ```javascript
  const handleSelectToken = async (integrationId) => {
    // 1. selectedIntegrationId ì €ì¥
    setSelectedIntegrationId(integrationId);

    // 2. Refresh Token ë³µí˜¸í™”
    const { data: decryptedToken } = await supabase.rpc('get_decrypted_token', {
      p_api_token_id: integrationId,
      p_token_type: 'refresh_token',
    });

    // 3. í‰ë¬¸ í† í°ì„ formDataì— ìë™ì…ë ¥
    setFormData(prev => ({
      ...prev,
      refreshToken: decryptedToken,
    }));
  };
  ```
- **ë³µí˜¸í™” í•¨ìˆ˜**: `get_decrypted_token(p_api_token_id UUID, p_token_type TEXT)`
  - ìœ„ì¹˜: `supabase/migrations/014_integrations_encryption.sql` (140-176ì¤„)
- **ê²°ê³¼**: í† í° ì„ íƒ ì‹œ Refresh Token ìë™ì…ë ¥ í™•ì¸ âœ…

### 3. âš ï¸ Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ Edge Function ìˆ˜ì • (ì˜¤ë¥˜ ë°œìƒ ì¤‘)

**ë¬¸ì œ**: Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨
```
Client credentials not found
```

**ì›ì¸**: OAuthë¡œ ìƒì„±ëœ `integration`ì—ëŠ” `client_id`/`client_secret`ì´ ì €ì¥ë˜ì§€ ì•ŠìŒ
- OAuth ì„¸ì…˜ í…Œì´ë¸”ì— 15ë¶„ê°„ ì„ì‹œ ì €ì¥ (ì´ë¯¸ ë§Œë£Œ)
- Client credentialsëŠ” **ì¡°ì§ GCP ì„¤ì •**ì— ì˜êµ¬ ì €ì¥ë¨

**ìˆ˜ì •**:
- **íŒŒì¼**: `supabase/functions/list-google-customers/index.ts`
- **ë³€ê²½ ì „** (101-124ì¤„):
  ```typescript
  // Integrationì—ì„œ client_id/client_secret ì¡°íšŒ ì‹œë„ (ì—†ìŒ)
  const { data: clientId } = await supabaseServiceRole.rpc(
    'get_decrypted_token',
    { p_api_token_id: integration_id, p_token_type: 'client_id' }
  );
  ```
- **ë³€ê²½ í›„**:
  ```typescript
  // ì¡°ì§ GCP Credentialsì—ì„œ ì¡°íšŒ
  const organizationId = integration.advertisers?.organization_id;
  const { data: gcpCredentials } = await supabaseServiceRole.rpc(
    'get_organization_gcp_credentials',
    { org_id: organizationId }
  );
  const { client_id: clientId, client_secret: clientSecret } = gcpCredentials[0];
  ```
- **ë°°í¬**: `supabase functions deploy list-google-customers --no-verify-jwt` âœ…

**í˜„ì¬ ìƒíƒœ**: ğŸ”´ ì—¬ì „íˆ 500 ì—ëŸ¬ ë°œìƒ
```
Error: Failed to list Google Ads customers
```

---

## ë¯¸í•´ê²° ë¬¸ì œ

### ğŸ”´ Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ 500 ì—ëŸ¬

**ì—ëŸ¬ ë¡œê·¸**:
```
POST https://qdzdyoqtzkfpcogecyar.supabase.co/functions/v1/list-google-customers
Status: 500 Internal Server Error

Error: Failed to list Google Ads customers
```

**ì¶”ì • ì›ì¸**:
1. **ê°€ëŠ¥ì„± 1**: `get_organization_gcp_credentials` RPC í•¨ìˆ˜ê°€ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì§€ ëª»í•¨
   - ì¡°ì§ GCP ì„¤ì •ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±
   - ì•”í˜¸í™” í‚¤ ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±

2. **ê°€ëŠ¥ì„± 2**: Google Ads API í˜¸ì¶œ ì‹¤íŒ¨
   - Access Token ë°œê¸‰ ì‹¤íŒ¨ (Refresh Token ë¬¸ì œ)
   - Developer Token ëˆ„ë½ ë˜ëŠ” ë¬´íš¨
   - API ê¶Œí•œ ë¬¸ì œ

3. **ê°€ëŠ¥ì„± 3**: `integration.advertisers?.organization_id` ì¡°íšŒ ì‹¤íŒ¨
   - SELECT ì¿¼ë¦¬ì—ì„œ JOINì´ ì œëŒ€ë¡œ ë˜ì§€ ì•ŠìŒ

**í•„ìš”í•œ ë””ë²„ê¹…**:
1. Edge Function ë¡œê·¸ í™•ì¸ (Supabase Dashboard)
2. ì¡°ì§ GCP ì„¤ì • í™•ì¸:
   ```sql
   SELECT * FROM organizations WHERE id = '<organization_id>';
   ```
3. `get_organization_gcp_credentials` RPC í•¨ìˆ˜ ì§ì ‘ í…ŒìŠ¤íŠ¸:
   ```sql
   SELECT * FROM get_organization_gcp_credentials('<organization_id>');
   ```

---

## ê´€ë ¨ íŒŒì¼ ëª©ë¡

### ìˆ˜ì •ëœ íŒŒì¼ (ì˜¤ëŠ˜ ì‘ì—…)
1. **SQL ë§ˆì´ê·¸ë ˆì´ì…˜**:
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/migrations/034_organization_shared_tokens.sql`
     - ë¼ì¸ 40, 50, 82, 100: ë³€ìˆ˜ëª… ì¶©ëŒ í•´ê²° (`v_org_id` â†’ `v_current_org_id`)
     - ë¼ì¸ 21-131: `get_organization_google_tokens` RPC í•¨ìˆ˜ ì „ì²´ ì •ì˜

2. **í”„ë¡ íŠ¸ì—”ë“œ**:
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/api-management/components/APITokenTable.js`
     - ë¼ì¸ 657-695: `handleSelectToken` í•¨ìˆ˜ - Refresh Token ìë™ì…ë ¥ ì¶”ê°€
     - ë¼ì¸ 671-747: `handleFetchGoogleCustomers` í•¨ìˆ˜ - Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ
     - ë¼ì¸ 477-490: `fetchOrganizationTokens` í•¨ìˆ˜ - ì¡°ì§ í† í° ëª©ë¡ ì¡°íšŒ
     - ë¼ì¸ 2114-2200: í† í° ì„ íƒ ëª¨ë‹¬ UI

3. **Edge Functions**:
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/list-google-customers/index.ts`
     - ë¼ì¸ 101-130: Client credentials ì¡°íšŒ ë¡œì§ ìˆ˜ì • (ì¡°ì§ GCPì—ì„œ ì¡°íšŒ)
     - ì „ì²´ 238ì¤„: Google Ads Customer ëª©ë¡ ì¡°íšŒ ë¡œì§

### í•µì‹¬ ì°¸ì¡° íŒŒì¼ (ì‹œìŠ¤í…œ ì´í•´ í•„ìˆ˜)

#### 1. ë¬¸ì„œ íŒŒì¼
- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/êµ¬ê¸€ì• ì¦ˆ_ì—°ë™_ì‘ì—…í˜„í™©.md`
  - **í•„ë…**: OAuth íë¦„, í† í° ì €ì¥ ë°©ì‹, ì•”í˜¸í™” í‚¤ ì •ë³´
  - ë¼ì¸ 32-51: í† í° ì €ì¥ ë°©ì‹ ìƒì„¸ ì„¤ëª…
  - ë¼ì¸ 301-304: ì•”í˜¸í™” ì»¬ëŸ¼ëª… ì •ë¦¬

- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/êµ¬ê¸€ì• ì¦ˆ_í† í°ì¡°íšŒ_ìˆ˜ì •ì™„ë£Œ.md`
  - ì¡°ì§ ë‹¨ìœ„ í† í° ê³µìœ  ê¸°ëŠ¥ ìƒì„¸ ì„¤ëª…

- `/Users/reon/.claude/plans/delegated-singing-galaxy.md`
  - ì¡°ì§ ë‹¨ìœ„ í† í° ê³µìœ  ì „ì²´ ê³„íš
  - ë¼ì¸ 296-304: í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

- `/Users/reon/.claude/plans/fuzzy-tickling-valley.md`
  - PostgreSQL ë³€ìˆ˜ ì¶©ëŒ ì˜¤ë¥˜ ë¶„ì„ ë° í•´ê²° ë°©ë²•

#### 2. SQL ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/migrations/003_oauth_tables.sql`
  - `integrations` í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì •ì˜
  - `advertisers` í…Œì´ë¸”ê³¼ì˜ ê´€ê³„

- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/migrations/014_integrations_encryption.sql`
  - **ì¤‘ìš”**: ë¼ì¸ 140-176: `get_decrypted_token` í•¨ìˆ˜ ì •ì˜
  - ë¼ì¸ 16-137: `store_encrypted_token` í•¨ìˆ˜ ì •ì˜
  - ì•”í˜¸í™”/ë³µí˜¸í™” ë¡œì§ í™•ì¸

- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/migrations/034_organization_shared_tokens.sql`
  - **ì‹ ê·œ ê¸°ëŠ¥**: ë¼ì¸ 6-9: `integrations` í…Œì´ë¸” ì»¬ëŸ¼ ì¶”ê°€
  - ë¼ì¸ 21-131: `get_organization_google_tokens` RPC í•¨ìˆ˜

- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/restore_pgcrypto_with_mcc.sql`
  - **ì¤‘ìš”**: `get_organization_gcp_credentials` í•¨ìˆ˜ ì •ì˜ í™•ì¸ í•„ìš”
  - `save_organization_gcp_credentials` í•¨ìˆ˜ ì •ì˜
  - `organizations` í…Œì´ë¸” GCP ì»¬ëŸ¼ êµ¬ì¡°

#### 3. Edge Functions (ê¸°ì¡´ ì‘ë™ ë¡œì§)
- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/oauth-callback/index.ts`
  - **ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€**: ë¼ì¸ 188-238: Google Ads OAuth í† í° ì•”í˜¸í™” ì €ì¥
  - ë¼ì¸ 240-273: Meta Ads Vault ì €ì¥ (ê¸°ì¡´ ë°©ì‹)
  - ë¼ì¸ 297: Refresh Tokenì„ í‰ë¬¸ìœ¼ë¡œ URL íŒŒë¼ë¯¸í„° ì „ë‹¬

- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/oauth-initiate/index.ts`
  - OAuth ì¸ì¦ URL ìƒì„±
  - ì„¸ì…˜ ì €ì¥ ë¡œì§

- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/collect-ad-data/index.ts`
  - **ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€**: ë°ì´í„° ìˆ˜ì§‘ ë¡œì§

#### 4. í”„ë¡ íŠ¸ì—”ë“œ ì°¸ì¡° íŒŒì¼
- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/public/oauth-callback.html`
  - ë¼ì¸ 82-91: postMessageë¡œ í‰ë¬¸ í† í° ì „ë‹¬
  - OAuth íŒì—… ì½œë°± ì²˜ë¦¬

- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/src/views/superadmin/default/index.jsx`
  - ì¡°ì§ GCP ì„¤ì • ì €ì¥ UI

#### 5. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì°¸ì¡°
- `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/database/schema.sql`
  - ì „ì²´ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸
  - `organizations`, `advertisers`, `integrations`, `users` ê´€ê³„

### ë””ë²„ê¹…ì— í•„ìš”í•œ íŒŒì¼ ëª©ë¡

#### ì¦‰ì‹œ í™•ì¸ í•„ìš”
1. **Supabase Dashboard ë¡œê·¸**:
   - URL: https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar/functions
   - `list-google-customers` í•¨ìˆ˜ì˜ ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸

2. **í™˜ê²½ ë³€ìˆ˜ íŒŒì¼**:
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/.env`
     - `REACT_APP_SUPABASE_URL`
     - `REACT_APP_SUPABASE_ANON_KEY`

3. **SQL ì‹¤í–‰ íŒŒì¼** (í•¨ìˆ˜ ì •ì˜ í™•ì¸ìš©):
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/restore_pgcrypto_with_mcc.sql`
     - `get_organization_gcp_credentials` í•¨ìˆ˜ì˜ RETURNS êµ¬ì¡° í™•ì¸
     - `organizations` í…Œì´ë¸” ì•”í˜¸í™” ì»¬ëŸ¼ëª… í™•ì¸

### ë³€ê²½í•˜ì§€ ì•Šì€ íŒŒì¼ (ê¸°ì¡´ ì‘ë™ ê¸°ëŠ¥ - ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€)
- âœ… `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/oauth-callback/index.ts` (OAuth í† í° ì €ì¥)
- âœ… `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/oauth-initiate/index.ts` (OAuth ì¸ì¦ ì‹œì‘)
- âœ… `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/public/oauth-callback.html` (postMessage ì²˜ë¦¬)
- âœ… `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/collect-ad-data/index.ts` (ë°ì´í„° ìˆ˜ì§‘)
- âœ… `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/supabase/functions/resolve-access-token/index.ts` (Meta í† í° ì¡°íšŒ)
- âœ… Meta Ads ê´€ë ¨ ëª¨ë“  ë¡œì§

---

## í•µì‹¬ ê¸°ìˆ  ì •ë³´

### í† í° ì €ì¥ ë°©ì‹
1. **Google Ads Refresh Token**: `integrations.refresh_token_encrypted` (BYTEA, pgcrypto)
2. **Meta Ads Access Token**: `integrations.access_token_encrypted` (BYTEA, pgcrypto)
3. **ì¡°ì§ GCP ì„¤ì •**: `organizations.google_*_encrypted` (TEXT, pgcrypto)

### ì•”í˜¸í™” í‚¤
```javascript
const encryptionKey = 'your-encryption-key-change-this-in-production';
```

### ë³µí˜¸í™” í•¨ìˆ˜
```sql
-- í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜
get_decrypted_token(
  p_api_token_id UUID,
  p_token_type TEXT  -- 'refresh_token', 'access_token', 'developer_token', 'client_secret'
)
RETURNS TEXT
```

### ì¡°ì§ GCP Credentials ì¡°íšŒ
```sql
-- í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ (í™•ì¸ í•„ìš”)
get_organization_gcp_credentials(org_id UUID)
RETURNS TABLE(
  client_id TEXT,
  client_secret TEXT,
  developer_token TEXT,
  mcc_id TEXT
)
```

---

## ë‹¤ìŒ ì‘ì—…ìë¥¼ ìœ„í•œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1. ì¦‰ì‹œ í™•ì¸ í•„ìš”
- [ ] Supabase Dashboard â†’ Functions â†’ `list-google-customers` ë¡œê·¸ í™•ì¸
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ ì •í™•íˆ íŒŒì•… (í˜„ì¬ëŠ” "Failed to list Google Ads customers"ë§Œ ë³´ì„)

### 2. SQL ê²€ì¦ (Supabase SQL Editorì—ì„œ ì‹¤í–‰)

**Step 1: í˜„ì¬ ì‚¬ìš©ìì˜ organization_id í™•ì¸**
```sql
SELECT id, email, organization_id, role
FROM users
WHERE email = 'agency.owner.test01@gmail.com';
-- ê²°ê³¼ì—ì„œ organization_id ë³µì‚¬
```

**Step 2: ì¡°ì§ GCP ì„¤ì • í™•ì¸**
```sql
SELECT
  id,
  name,
  google_client_id_encrypted IS NOT NULL as has_client_id,
  google_client_secret_encrypted IS NOT NULL as has_client_secret,
  google_developer_token_encrypted IS NOT NULL as has_dev_token,
  google_mcc_id_encrypted IS NOT NULL as has_mcc_id,
  LENGTH(google_client_id_encrypted) as client_id_length,
  LENGTH(google_client_secret_encrypted) as client_secret_length
FROM organizations
WHERE id = '<Step1ì—ì„œ_ë³µì‚¬í•œ_organization_id>';
-- ëª¨ë“  has_* ì»¬ëŸ¼ì´ trueì—¬ì•¼ í•¨
```

**Step 3: get_organization_gcp_credentials í•¨ìˆ˜ í…ŒìŠ¤íŠ¸**
```sql
SELECT * FROM get_organization_gcp_credentials('<organization_id>');
-- ê²°ê³¼ê°€ ë¹„ì–´ìˆìœ¼ë©´ í•¨ìˆ˜ ì˜¤ë¥˜
-- ê²°ê³¼ê°€ ìˆìœ¼ë©´ client_id, client_secretì´ nullì´ ì•„ë‹Œì§€ í™•ì¸
```

**Step 4: ìµœê·¼ ìƒì„±ëœ Integration í™•ì¸**
```sql
SELECT
  i.id,
  i.platform,
  i.advertiser_id,
  a.organization_id,
  a.name as advertiser_name,
  i.refresh_token_encrypted IS NOT NULL as has_refresh_token,
  i.google_account_email,
  i.created_at
FROM integrations i
JOIN advertisers a ON i.advertiser_id = a.id
WHERE i.platform = 'Google Ads'
  AND i.deleted_at IS NULL
ORDER BY i.created_at DESC
LIMIT 5;
-- ê°€ì¥ ìµœê·¼ì— ì„ íƒí•œ integration_id í™•ì¸
```

**Step 5: Developer Token í™•ì¸**
```sql
SELECT
  id,
  platform,
  developer_token_encrypted IS NOT NULL as has_dev_token
FROM integrations
WHERE id = '<Step4ì—ì„œ_í™•ì¸í•œ_integration_id>';
-- has_dev_tokenì´ falseë©´ developer_tokenì´ ì €ì¥ë˜ì§€ ì•Šì€ ê²ƒ
```

**Step 6: get_decrypted_token í•¨ìˆ˜ ì§ì ‘ í…ŒìŠ¤íŠ¸**
```sql
-- Refresh Token ë³µí˜¸í™” í…ŒìŠ¤íŠ¸
SELECT get_decrypted_token(
  '<integration_id>'::UUID,
  'refresh_token'
);

-- Developer Token ë³µí˜¸í™” í…ŒìŠ¤íŠ¸
SELECT get_decrypted_token(
  '<integration_id>'::UUID,
  'developer_token'
);
-- NULLì´ ë°˜í™˜ë˜ë©´ í•´ë‹¹ í† í°ì´ ì €ì¥ë˜ì§€ ì•Šì€ ê²ƒ
```

### 3. Edge Function ë””ë²„ê¹…
- [ ] `list-google-customers/index.ts` 102-130ì¤„ì— console.log ì¶”ê°€
  ```typescript
  console.log('Organization ID:', organizationId);
  console.log('GCP Credentials:', gcpCredentials);
  console.log('Client ID exists:', !!clientId);
  ```
- [ ] ì¬ë°°í¬ í›„ ë¡œê·¸ í™•ì¸

### 4. ëŒ€ì•ˆ ì ‘ê·¼ë²•
ë§Œì•½ ì¡°ì§ GCP credentials ì¡°íšŒê°€ ê³„ì† ì‹¤íŒ¨í•œë‹¤ë©´:
- **Plan B**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Client ID/Secretì„ ì§ì ‘ ì „ë‹¬
  - ë³´ì•ˆìƒ ê¶Œì¥í•˜ì§€ ì•Šì§€ë§Œ ë””ë²„ê¹…ìš©ìœ¼ë¡œ ì‹œë„ ê°€ëŠ¥
  - `handleFetchGoogleCustomers` í•¨ìˆ˜ì—ì„œ `formData.clientId`, `formData.clientSecret` ì „ë‹¬

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### í˜„ì¬ ì´ìŠˆ
- âš ï¸ `get_decrypted_token` RPC ì‘ë‹µì´ ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì— í‰ë¬¸ìœ¼ë¡œ ë…¸ì¶œ
  - HTTPSë¡œ ì „ì†¡ë˜ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ì€ ì•ˆì „
  - ì‚¬ìš©ì ë³¸ì¸ì˜ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ë³´ì„
  - í•˜ì§€ë§Œ ë³´ì•ˆ ê°•í™” í•„ìš” ì‹œ Edge Functionì„ í†µí•´ ì²˜ë¦¬ ê¶Œì¥

### ê¶Œì¥ ì‚¬í•­
1. RPC ëŒ€ì‹  Edge Functionìœ¼ë¡œ í† í° ì²˜ë¦¬
2. ì•”í˜¸í™” í‚¤ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì´ë™ (í˜„ì¬ í•˜ë“œì½”ë”©ë¨)
3. Service Role Key ë…¸ì¶œ ë°©ì§€ ì² ì €íˆ í™•ì¸

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì„±ê³µ ì‹œë‚˜ë¦¬ì˜¤ (ì•„ì§ ë¯¸ë‹¬ì„±)
1. `/superadmin/api-management` ì ‘ì†
2. ë¸Œëœë“œ ì„ íƒ
3. "Google ê³„ì • ì—°ê²°" í´ë¦­
4. ì¡°ì§ì˜ ê¸°ì¡´ í† í° ëª©ë¡ í‘œì‹œ âœ…
5. í† í° ì„ íƒ â†’ Refresh Token ìë™ì…ë ¥ âœ…
6. "Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ" í´ë¦­
7. Customer ëª©ë¡ ë“œë¡­ë‹¤ìš´ í‘œì‹œ âŒ (í˜„ì¬ ì‹¤íŒ¨)
8. Customer ì„ íƒ â†’ Customer ID ìë™ì…ë ¥
9. ì €ì¥ ì™„ë£Œ

---

## ì°¸ê³  ë§í¬

- **Supabase Project**: https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar
- **Edge Functions Dashboard**: https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar/functions
- **Google Ads API Docs**: https://developers.google.com/google-ads/api/docs/start

---

## ì‘ì—… ì‹œê°„

- **ì‹œì‘**: 2026-01-20 (ì •í™•í•œ ì‹œê°„ ë¯¸ê¸°ë¡)
- **ì™„ë£Œ**: ë¯¸ì™„ë£Œ
- **ì†Œìš” ì‹œê°„**: ì•½ 2-3ì‹œê°„ (ì¶”ì •)

---

## ë°°í¬ ë° í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´

### Edge Function ë°°í¬
```bash
cd /Users/reon/Desktop/ê°œë°œ/growth-dashboard

# list-google-customers ë°°í¬
supabase functions deploy list-google-customers --no-verify-jwt

# ë¡œê·¸ í™•ì¸ (Supabase Dashboard ì‚¬ìš© ê¶Œì¥)
# CLI ë¡œê·¸ ëª…ë ¹ì–´ëŠ” ì œí•œì ì´ë¯€ë¡œ Dashboardì—ì„œ í™•ì¸í•˜ì„¸ìš”
```

### í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
1. ë¸Œë¼ìš°ì €ì—ì„œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (Ctrl+Shift+R ë˜ëŠ” Cmd+Shift+R)
2. ê°œë°œì ë„êµ¬ ì½˜ì†” ì—´ê¸° (F12)
3. Network íƒ­ì—ì„œ ìš”ì²­ í™•ì¸
4. `/superadmin/api-management` í˜ì´ì§€ ì ‘ì†
5. ë¸Œëœë“œ ì„ íƒ â†’ "Google ê³„ì • ì—°ê²°" í´ë¦­
6. ì½˜ì†” ë¡œê·¸ í™•ì¸:
   ```
   [í† í° ì¡°íšŒ] ì‚¬ìš©ì ì´ë©”ì¼: ...
   [í† í° ì¡°íšŒ] ê²°ê³¼: [...]
   [OAuth Connect] ì¡°íšŒëœ í† í° ê°œìˆ˜: ...
   ```

### ë¸Œë¼ìš°ì € ìºì‹œ í´ë¦¬ì–´
ë§Œì•½ ìˆ˜ì • ì‚¬í•­ì´ ë°˜ì˜ë˜ì§€ ì•Šìœ¼ë©´:
1. ê°œë°œì ë„êµ¬ ì—´ê¸° (F12)
2. Network íƒ­ â†’ "Disable cache" ì²´í¬
3. ë˜ëŠ” í•˜ë“œ ë¦¬ë¡œë“œ: Ctrl+Shift+R (Windows) / Cmd+Shift+R (Mac)

---

## ë‹¤ìŒ Claudeì—ê²Œ

### í•„ìˆ˜ ìˆœì„œ
1. âœ… **ë¨¼ì € ì´ íŒŒì¼ ì „ì²´ë¥¼ ì •ë…í•˜ì„¸ìš”** (íŠ¹íˆ "ê´€ë ¨ íŒŒì¼ ëª©ë¡" ì„¹ì…˜)
2. âœ… **ë‹¤ìŒ 3ê°œ ë¬¸ì„œë¥¼ ë°˜ë“œì‹œ ì½ìœ¼ì„¸ìš”**:
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/êµ¬ê¸€ì• ì¦ˆ_ì—°ë™_ì‘ì—…í˜„í™©.md`
   - `/Users/reon/Desktop/ê°œë°œ/growth-dashboard/êµ¬ê¸€ì• ì¦ˆ_í† í°ì¡°íšŒ_ìˆ˜ì •ì™„ë£Œ.md`
   - `/Users/reon/.claude/plans/delegated-singing-galaxy.md`

3. âœ… **Supabase Dashboardì—ì„œ Edge Function ë¡œê·¸ í™•ì¸**:
   - https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar/functions
   - `list-google-customers` í•¨ìˆ˜ í´ë¦­
   - Logs íƒ­ì—ì„œ ìµœê·¼ ì—ëŸ¬ í™•ì¸
   - ì •í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ íŒŒì•…

4. âœ… **SQL ê²€ì¦ ì‹¤í–‰** (ìœ„ì˜ "SQL ê²€ì¦" ì„¹ì…˜ Step 1~6 ìˆœì„œëŒ€ë¡œ):
   - Supabase SQL Editorì—ì„œ í•˜ë‚˜ì”© ì‹¤í–‰
   - ê° ë‹¨ê³„ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ë©° ë¬¸ì œ ì§€ì  íŒŒì•…

5. âœ… **ë¬¸ì œ íŒŒì•… í›„ ìˆ˜ì •**:
   - ê¸°ì¡´ ì‘ë™í•˜ë˜ ì‹œìŠ¤í…œ(OAuth, ë°ì´í„° ìˆ˜ì§‘, Meta Ads) ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€
   - ì‹ ê·œ ê¸°ëŠ¥ë§Œ ìˆ˜ì • (`list-google-customers`, `handleSelectToken`, `get_organization_google_tokens`)

### ì ˆëŒ€ ê·œì¹™
- âŒ **ì¶”ì¸¡ ê¸ˆì§€** - ëª¨ë“  ê²ƒì„ ì§ì ‘ í™•ì¸í•˜ì„¸ìš”
- âŒ **ê¸°ì¡´ ë¡œì§ ìˆ˜ì • ê¸ˆì§€** - "ë³€ê²½í•˜ì§€ ì•Šì€ íŒŒì¼" ì„¹ì…˜ì˜ íŒŒì¼ë“¤ì€ ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”
- âœ… **í™•ì¸ ìš°ì„ ** - ì½”ë“œ ìˆ˜ì • ì „ì— SQLë¡œ ë°ì´í„° ìƒíƒœë¥¼ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”
- âœ… **ë¡œê·¸ ìš°ì„ ** - Edge Function ë¡œê·¸ì—ì„œ ì •í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë¨¼ì € íŒŒì•…í•˜ì„¸ìš”

### í˜„ì¬ ê°€ì¥ ì˜ì‹¬ë˜ëŠ” ì›ì¸
1. **Developer Token ë¯¸ì €ì¥**: OAuthë¡œ ìƒì„±ëœ integrationì—ëŠ” developer_tokenì´ ì €ì¥ë˜ì§€ ì•Šì•˜ì„ ê°€ëŠ¥ì„±
   - Edge Function 86-99ì¤„ì—ì„œ developer_token ì¡°íšŒ ì‹œ NULL ë°˜í™˜
   - í•´ê²°: OAuth ì‹œ developer_tokenë„ í•¨ê»˜ ì €ì¥í•˜ë„ë¡ ìˆ˜ì • í•„ìš”

2. **ì¡°ì§ GCP credentials ì¡°íšŒ ì‹¤íŒ¨**: `get_organization_gcp_credentials` í•¨ìˆ˜ ì˜¤ë¥˜
   - í•¨ìˆ˜ ì •ì˜ í™•ì¸: `restore_pgcrypto_with_mcc.sql` íŒŒì¼ ì½ê¸°
   - RETURNS êµ¬ì¡°ê°€ ë°°ì—´ì¸ì§€ ë‹¨ì¼ í–‰ì¸ì§€ í™•ì¸

3. **integration.advertisers?.organization_id ë¯¸ì¡°íšŒ**: JOIN ì¿¼ë¦¬ ë¬¸ì œ
   - Edge Function 51ì¤„ì˜ SELECT ì¿¼ë¦¬ì—ì„œ `advertisers(organization_id)` í˜•ì‹ í™•ì¸
