# êµ¬ê¸€ ì• ì¦ˆ ì¡°ì§ ë‹¨ìœ„ í† í° ê³µìœ  ì‘ì—… ë‚´ì—­ (2026-01-20 ~ 2026-01-21)

## ì‘ì—… ê°œìš”

**ëª©ì **: ê°™ì€ ì¡°ì§ ë‚´ì—ì„œ ê¸°ì¡´ Google Ads Refresh Tokenì„ ì¬ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ OAuth ì¸ì¦ ë°©ì§€

**ìƒíƒœ**: âœ… **ì™„ë£Œ** (2026-01-21)

---

## ì™„ë£Œëœ ì‘ì—…

### 1. âœ… PostgreSQL RPC í•¨ìˆ˜ ì˜¤ë¥˜ ìˆ˜ì • (2026-01-20)

**ë¬¸ì œ**: `get_organization_google_tokens` RPC í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ì˜¤ë¥˜
```
column reference "organization_id" is ambiguous
```

**ì›ì¸**: PL/pgSQL ë³€ìˆ˜ëª… `v_org_id`ì™€ í…Œì´ë¸” ì»¬ëŸ¼ëª… `organization_id` ì¶©ëŒ

**í•´ê²°**:
- **íŒŒì¼**: `supabase/migrations/034_organization_shared_tokens.sql`
- **ìˆ˜ì •**: ë³€ìˆ˜ëª… `v_org_id` â†’ `v_current_org_id` (4ê³³)
  - 40ë²ˆì§¸ ì¤„: DECLARE ë¸”ë¡
  - 50ë²ˆì§¸ ì¤„: SELECT INTO êµ¬ë¬¸
  - 82ë²ˆì§¸ ì¤„: NULL ì²´í¬
  - 100ë²ˆì§¸ ì¤„: WHERE ì¡°ê±´
- **ê²°ê³¼**: RPC í•¨ìˆ˜ ì •ìƒ ì‘ë™ í™•ì¸ âœ…

---

### 2. âœ… í† í° ì„ íƒ ì‹œ Refresh Token ìë™ì…ë ¥ ì¶”ê°€ (2026-01-20)

**ë¬¸ì œ**: ê¸°ì¡´ í† í° ì„ íƒ ì‹œ Refresh Tokenì´ ìë™ìœ¼ë¡œ í•„ë“œì— ì…ë ¥ë˜ì§€ ì•ŠìŒ

**ë¶„ì„**:
- **OAuth ì„±ê³µ ì‹œ**: `oauth-callback.html`ì—ì„œ í‰ë¬¸ í† í°ì„ postMessageë¡œ ì „ë‹¬ â†’ ìë™ì…ë ¥ âœ…
- **ê¸°ì¡´ í† í° ì„ íƒ ì‹œ**: `integration_id`ë§Œ ì €ì¥í•˜ê³  í† í° ë³µí˜¸í™” ì—†ìŒ âŒ

**í•´ê²°**:
- **íŒŒì¼**: `src/views/superadmin/api-management/components/APITokenTable.js`
- **í•¨ìˆ˜**: `handleSelectToken` (657-714ë²ˆì§¸ ì¤„)
- **ìˆ˜ì • ë‚´ìš©**:
  ```javascript
  const handleSelectToken = async (integrationId) => {
    setSelectedIntegrationId(integrationId);

    // Refresh Token ë³µí˜¸í™” ë° ìë™ì…ë ¥
    const { data: decryptedToken } = await supabase.rpc('get_decrypted_token', {
      p_api_token_id: integrationId,
      p_token_type: 'refresh_token',
    });

    if (decryptedToken) {
      setFormData(prev => ({
        ...prev,
        refreshToken: decryptedToken,
      }));
    }

    onTokenSelectModalClose();
  };
  ```
- **ê²°ê³¼**: í† í° ì„ íƒ ì‹œ Refresh Token ìë™ì…ë ¥ í™•ì¸ âœ…

---

### 3. âœ… Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ Edge Function ìˆ˜ì • (2026-01-21)

#### 3-1. ë¬¸ì œ ì§„ë‹¨

**ì´ˆê¸° ì—ëŸ¬**:
```
Operation is not implemented, or supported, or enabled
(Google Ads API 501 ì—ëŸ¬)
```

**ì›ì¸ ë¶„ì„**:
1. **API ë²„ì „ ë¶ˆì¼ì¹˜**: v18 (deprecated) ì‚¬ìš©, v22ë¡œ ì—…ê·¸ë ˆì´ë“œ í•„ìš”
2. **MCC í—¤ë” ëˆ„ë½**: Manager ê³„ì • ì¡°íšŒë¥¼ ìœ„í•œ `login-customer-id` í—¤ë” í•„ìš”
3. **API ë©”ì†Œë“œ ë³€ê²½**: `googleAds:search` â†’ `googleAds:searchStream` ë³€ê²½ í•„ìš”
4. **ì‘ë‹µ íŒŒì‹±**: newline-delimited JSON íŒŒì‹± í•„ìš”

#### 3-2. Edge Function ìˆ˜ì •

**íŒŒì¼**: `supabase/functions/list-google-customers/index.ts`

**ë³€ê²½ 1: Integration ì¿¼ë¦¬ì— MCC ID ì¶”ê°€** (Line 51)
```typescript
// ë³€ê²½ ì „
.select('id, platform, advertiser_id, advertisers(organization_id)')

// ë³€ê²½ í›„
.select('id, platform, advertiser_id, legacy_manager_account_id, advertisers(organization_id)')
```

**ë³€ê²½ 2: API v18 â†’ v22 + MCC í—¤ë” ì¶”ê°€** (Line 155-173)
```typescript
// MCC ID ì¶”ì¶œ
const managerAccountId = integration.legacy_manager_account_id;

// í—¤ë” êµ¬ì„±
const listHeaders: any = {
  'Authorization': `Bearer ${access_token}`,
  'developer-token': developerToken,
};

if (managerAccountId) {
  listHeaders['login-customer-id'] = managerAccountId;
}

// API í˜¸ì¶œ (v18 â†’ v22)
const listResponse = await fetch(
  'https://googleads.googleapis.com/v22/customers:listAccessibleCustomers',
  { headers: listHeaders }
);
```

**ë³€ê²½ 3: searchStream ì ìš©** (Line 198-234)
```typescript
const detailHeaders: any = {
  'Authorization': `Bearer ${access_token}`,
  'developer-token': developerToken,
  'Content-Type': 'application/json',
};

if (managerAccountId) {
  detailHeaders['login-customer-id'] = managerAccountId;
}

const detailResponse = await fetch(
  `https://googleads.googleapis.com/v22/customers/${customerId}/googleAds:searchStream`,
  {
    method: 'POST',
    headers: detailHeaders,
    body: JSON.stringify({ query }),
  }
);

// newline-delimited JSON íŒŒì‹±
const responseText = await detailResponse.text();
const allResults = parseGoogleAdsResponse(responseText);
const result = allResults[0]?.customer;
```

**ë³€ê²½ 4: ì‘ë‹µ íŒŒì„œ í•¨ìˆ˜ ì¶”ê°€** (Line 245-284)
```typescript
function parseGoogleAdsResponse(responseText: string): any[] {
  let allResults: any[] = [];

  try {
    // ì™„ì „í•œ JSON ë°°ì—´ë¡œ íŒŒì‹± ì‹œë„
    const jsonArray = JSON.parse(responseText);
    if (Array.isArray(jsonArray)) {
      for (const item of jsonArray) {
        if (item.results && Array.isArray(item.results)) {
          allResults = allResults.concat(item.results);
        }
      }
    } else if (jsonArray.results && Array.isArray(jsonArray.results)) {
      allResults = jsonArray.results;
    }
  } catch {
    // Fallback: newline-delimited JSON íŒŒì‹±
    const lines = responseText.trim().split('\n').filter(line => line.trim());
    for (const line of lines) {
      try {
        const json = JSON.parse(line);
        if (json.results && Array.isArray(json.results)) {
          allResults = allResults.concat(json.results);
        }
      } catch {
        // ê°œë³„ ë¼ì¸ íŒŒì‹± ì‹¤íŒ¨ ë¬´ì‹œ
      }
    }
  }

  return allResults;
}
```

---

### 4. âœ… í”„ë¡ íŠ¸ì—”ë“œ API í˜¸ì¶œ ìˆ˜ì • (2026-01-21)

**ë¬¸ì œ**: 401 Unauthorized ì—ëŸ¬ ë°œìƒ

**ì›ì¸**: Edge Function í˜¸ì¶œ ì‹œ `apikey` í—¤ë” ëˆ„ë½

**í•´ê²°**:
- **íŒŒì¼**: `src/views/superadmin/api-management/components/APITokenTable.js`
- **ìœ„ì¹˜**: Line 735-744 (`handleFetchGoogleCustomers` í•¨ìˆ˜)
- **ìˆ˜ì •**:
  ```javascript
  const response = await fetch(`${process.env.REACT_APP_SUPABASE_URL}/functions/v1/list-google-customers`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`,
      'apikey': process.env.REACT_APP_SUPABASE_ANON_KEY,  // âœ… ì¶”ê°€
    },
    body: JSON.stringify({
      integration_id: selectedIntegrationId,
    }),
  });
  ```
- **ê²°ê³¼**: ì¸ì¦ ë¬¸ì œ í•´ê²° âœ…

---

## ìµœì¢… ê²°ê³¼

### âœ… ì„±ê³µ ì‹œë‚˜ë¦¬ì˜¤

1. `/superadmin/api-management` ì ‘ì†
2. ë¸Œëœë“œ ì„ íƒ
3. "Google ê³„ì • ì—°ê²°" í´ë¦­
4. **ì¡°ì§ì˜ ê¸°ì¡´ í† í° ëª©ë¡ í‘œì‹œ** âœ…
5. **í† í° ì„ íƒ â†’ Refresh Token ìë™ì…ë ¥** âœ…
6. **"Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ" í´ë¦­** âœ…
7. **Customer ëª©ë¡ ë“œë¡­ë‹¤ìš´ í‘œì‹œ** âœ…
8. Customer ì„ íƒ â†’ Customer ID ìë™ì…ë ¥
9. ì €ì¥ ì™„ë£Œ

### ì£¼ìš” ê°œì„ ì‚¬í•­

1. **API í‘œì¤€í™”**: Google Ads API v22 ì‚¬ìš© (ë°ì´í„° ìˆ˜ì§‘ê¸°ì™€ ë™ì¼)
2. **MCC ì§€ì›**: Manager ê³„ì •ì˜ í•˜ìœ„ ê³„ì • ì¡°íšŒ ê°€ëŠ¥
3. **ì•ˆì •ì„± í–¥ìƒ**: í‘œì¤€ API ë©”ì†Œë“œ ì‚¬ìš©ìœ¼ë¡œ í˜¸í™˜ì„± ë³´ì¥
4. **í† í° ì¬ì‚¬ìš©**: ì¡°ì§ ë‚´ ê¸°ì¡´ í† í° ì„ íƒìœ¼ë¡œ ì¤‘ë³µ OAuth ë°©ì§€

---

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### Edge Function
- `supabase/functions/list-google-customers/index.ts`
  - Line 51: Integration ì¿¼ë¦¬ ìˆ˜ì • (MCC ID ì¶”ê°€)
  - Line 155-173: API v22 + MCC í—¤ë”
  - Line 198-234: searchStream ì ìš©
  - Line 245-284: ì‘ë‹µ íŒŒì„œ í•¨ìˆ˜ ì¶”ê°€

### í”„ë¡ íŠ¸ì—”ë“œ
- `src/views/superadmin/api-management/components/APITokenTable.js`
  - Line 657-714: `handleSelectToken` - Refresh Token ìë™ì…ë ¥
  - Line 735-744: `handleFetchGoogleCustomers` - apikey í—¤ë” ì¶”ê°€

### SQL ë§ˆì´ê·¸ë ˆì´ì…˜
- `supabase/migrations/034_organization_shared_tokens.sql`
  - Line 40, 50, 82, 100: ë³€ìˆ˜ëª… ì¶©ëŒ í•´ê²°

---

## ê¸°ìˆ  ìƒì„¸

### API ë³€ê²½ ì‚¬í•­

| í•­ëª© | ë³€ê²½ ì „ (v18) | ë³€ê²½ í›„ (v22) |
|------|--------------|--------------|
| API ë²„ì „ | v18 | v22 |
| listAccessibleCustomers | v18/customers:listAccessibleCustomers | v22/customers:listAccessibleCustomers |
| ìƒì„¸ ì¡°íšŒ ë©”ì†Œë“œ | googleAds:search | googleAds:searchStream |
| ì‘ë‹µ í˜•ì‹ | JSON ê°ì²´ | Newline-delimited JSON |
| MCC í—¤ë” | ì—†ìŒ | login-customer-id (ì¡°ê±´ë¶€) |

### ì‘ë‹µ íŒŒì‹± ë°©ì‹

**v18 (êµ¬)**:
```javascript
const detailData = await detailResponse.json();
const result = detailData.results?.[0]?.customer;
```

**v22 (ì‹ )**:
```javascript
const responseText = await detailResponse.text();
const allResults = parseGoogleAdsResponse(responseText);
const result = allResults[0]?.customer;
```

---

## ë°°í¬ ëª…ë ¹ì–´

### Edge Function ë°°í¬
```bash
cd "c:\Users\REON\Desktop\ìƒˆ í´ë”\growth-dashboard"
export SUPABASE_ACCESS_TOKEN="sbp_..."
npx supabase functions deploy list-google-customers --no-verify-jwt
```

### í…ŒìŠ¤íŠ¸
1. ë¸Œë¼ìš°ì € í•˜ë“œ ë¦¬í”„ë ˆì‹œ (Ctrl+Shift+R)
2. `/superadmin/api-management` í˜ì´ì§€ ì ‘ì†
3. Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸

---

## ì°¸ê³  ë§í¬

- **Supabase Project**: https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar
- **Edge Functions Dashboard**: https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar/functions
- **Google Ads API v22 Docs**: https://developers.google.com/google-ads/api/docs/start

---

## ì‘ì—… ì‹œê°„

- **ì‹œì‘**: 2026-01-20
- **ì™„ë£Œ**: 2026-01-21
- **ì†Œìš” ì‹œê°„**: ì•½ 4ì‹œê°„

---

## ë³€ê²½í•˜ì§€ ì•Šì€ íŒŒì¼ (ê¸°ì¡´ ì‘ë™ ê¸°ëŠ¥ ìœ ì§€)

âœ… ë‹¤ìŒ íŒŒì¼ë“¤ì€ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ìœ¼ë©° ì •ìƒ ì‘ë™ í™•ì¸:
- `supabase/functions/oauth-callback/index.ts` (OAuth í† í° ì €ì¥)
- `supabase/functions/oauth-initiate/index.ts` (OAuth ì¸ì¦ ì‹œì‘)
- `supabase/functions/collect-ad-data/index.ts` (ë°ì´í„° ìˆ˜ì§‘)
- `supabase/functions/resolve-access-token/index.ts` (Meta í† í° ì¡°íšŒ)
- `public/oauth-callback.html` (postMessage ì²˜ë¦¬)
- Meta Ads ê´€ë ¨ ëª¨ë“  ë¡œì§

**ì˜í–¥ ë²”ìœ„**: Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ ê¸°ëŠ¥ë§Œ ìˆ˜ì •, ê¸°ì¡´ ë°ì´í„° ìˆ˜ì§‘ ë° OAuth ë¡œì§ ì˜í–¥ ì—†ìŒ âœ…

---

## 5. âœ… í† í° ë³µí˜¸í™” í•¨ìˆ˜ Base64 ë””ì½”ë”© ì¶”ê°€ (2026-01-22)

### ë¬¸ì œ ë°œê²¬

**ì—ëŸ¬ ìƒí™©**:
```
Request URL: https://qdzdyoqtzkfpcogecyar.supabase.co/functions/v1/list-google-customers
Status: 500 Internal Server Error
Error: {"error":"Failed to retrieve refresh token"}
```

**Edge Function ë¡œê·¸**: ë¡œê·¸ ì—†ìŒ (í•¨ìˆ˜ ì‹¤í–‰ ì „ ì‹¤íŒ¨)

**DB í™•ì¸**:
```sql
SELECT
  id,
  oauth_refresh_token_encrypted IS NOT NULL as has_oauth_refresh_token
FROM integrations
WHERE id = '3fe79b71-d5f6-4a66-b309-f6efa14cb2db';
```
ê²°ê³¼: `has_oauth_refresh_token = true` âœ… (í† í° ì¡´ì¬)

**RPC í•¨ìˆ˜ í…ŒìŠ¤íŠ¸**:
```sql
SELECT get_decrypted_token(
  '3fe79b71-d5f6-4a66-b309-f6efa14cb2db',
  'oauth_refresh_token'
);
```
ì—ëŸ¬: `ERROR: 39000: Wrong key or corrupt data`

---

### ì›ì¸ ë¶„ì„

#### 1. ì•”í˜¸í™” ë°©ì‹ í™•ì¸ (`encrypt_oauth_tokens`)

**íŒŒì¼**: `supabase/functions/oauth-callback/index.ts` (Line 242-246)
```typescript
const { data: encryptedTokens } = await supabaseServiceRole
  .rpc('encrypt_oauth_tokens', {
    p_access_token: accessToken,
    p_refresh_token: refreshToken,
    p_encryption_key: encryptionKey,  // Line 209: 'your-encryption-key-change-this-in-production'
  });
```

**RPC í•¨ìˆ˜**: `encrypt_oauth_tokens`
```sql
CREATE OR REPLACE FUNCTION public.encrypt_oauth_tokens(...)
RETURNS TABLE(access_token_encrypted text, refresh_token_encrypted text)
AS $function$
BEGIN
  RETURN QUERY SELECT
    encode(pgp_sym_encrypt(p_access_token, p_encryption_key), 'base64')::text,
    encode(pgp_sym_encrypt(p_refresh_token, p_encryption_key), 'base64')::text;
END;
$function$
```

**ì•”í˜¸í™” ê³¼ì •**:
1. `pgp_sym_encrypt` â†’ BYTEA ë°˜í™˜
2. `encode(..., 'base64')` â†’ **Base64 ì¸ì½”ë”©**
3. `::text` â†’ TEXT íƒ€ì…ìœ¼ë¡œ ì €ì¥

---

#### 2. ë³µí˜¸í™” ë°©ì‹ í™•ì¸ (`get_decrypted_token`)

**ê¸°ì¡´ RPC í•¨ìˆ˜** (ìˆ˜ì • ì „):
```sql
CREATE OR REPLACE FUNCTION public.get_decrypted_token(...)
AS $function$
DECLARE
  encrypted_value BYTEA;  -- âŒ TEXTë¡œ ì €ì¥ëœ ë°ì´í„°ë¥¼ BYTEAë¡œ ì½ìœ¼ë ¤ í•¨
BEGIN
  EXECUTE format(...) INTO encrypted_value USING p_api_token_id;

  decrypted_value := pgp_sym_decrypt(encrypted_value, encryption_key);  -- âŒ Base64 ë””ì½”ë”© ëˆ„ë½
  RETURN decrypted_value;
END;
$function$
```

**ë¬¸ì œì **:
1. **íƒ€ì… ë¶ˆì¼ì¹˜**: DBì—ëŠ” TEXT (Base64 ë¬¸ìì—´) ì €ì¥, í•¨ìˆ˜ëŠ” BYTEAë¡œ ì½ìŒ
2. **Base64 ë””ì½”ë”© ëˆ„ë½**: ì•”í˜¸í™” ì‹œ `encode(..., 'base64')` í–ˆì§€ë§Œ, ë³µí˜¸í™” ì‹œ `decode(..., 'base64')` í•˜ì§€ ì•ŠìŒ
3. **"Wrong key or corrupt data" ì—ëŸ¬**: Base64 ë¬¸ìì—´ì„ ë°”ë¡œ ë³µí˜¸í™”í•˜ë ¤ í•´ì„œ ë°œìƒ

---

### í•´ê²° ë°©ë²•

**ìˆ˜ì •ëœ RPC í•¨ìˆ˜**:
```sql
CREATE OR REPLACE FUNCTION public.get_decrypted_token(p_api_token_id uuid, p_token_type text)
RETURNS text
LANGUAGE plpgsql
SECURITY DEFINER
AS $function$
DECLARE
  encryption_key TEXT;
  encrypted_value TEXT;  -- âœ… BYTEA â†’ TEXT ë³€ê²½
  decrypted_value TEXT;
BEGIN
  encryption_key := 'your-encryption-key-change-this-in-production';

  -- integrations í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
  EXECUTE format(
    'SELECT %I FROM integrations WHERE id = $1',
    p_token_type || '_encrypted'
  ) INTO encrypted_value USING p_api_token_id;

  -- integrationsì— ì—†ìœ¼ë©´ api_tokensì—ì„œ ì¡°íšŒ (í•˜ìœ„ í˜¸í™˜ì„±)
  IF encrypted_value IS NULL AND EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'api_tokens') THEN
    EXECUTE format(
      'SELECT %I FROM api_tokens WHERE id = $1',
      p_token_type || '_encrypted'
    ) INTO encrypted_value USING p_api_token_id;
  END IF;

  IF encrypted_value IS NULL THEN
    RETURN NULL;
  END IF;

  -- âœ… Base64 ë””ì½”ë”© í›„ ë³µí˜¸í™”
  decrypted_value := pgp_sym_decrypt(decode(encrypted_value, 'base64'), encryption_key);
  RETURN decrypted_value;
END;
$function$;
```

**ë³€ê²½ ì‚¬í•­**:
1. **Line 7**: `encrypted_value BYTEA` â†’ `TEXT`
2. **Line 31**: `pgp_sym_decrypt(encrypted_value, ...)` â†’ `pgp_sym_decrypt(decode(encrypted_value, 'base64'), ...)`

---

### ìˆ˜ì • ë°©ë²•

**Supabase Dashboard SQL Editor**ì—ì„œ ìœ„ SQL ì‹¤í–‰:
1. https://supabase.com/dashboard/project/qdzdyoqtzkfpcogecyar/sql/new
2. ìˆ˜ì •ëœ í•¨ìˆ˜ ì •ì˜ ì „ì²´ ë³µì‚¬
3. Run ë²„íŠ¼ í´ë¦­
4. ê²°ê³¼: `Success. No rows returned`

---

### ê²€ì¦

**RPC í•¨ìˆ˜ ì¬í…ŒìŠ¤íŠ¸**:
```sql
SELECT get_decrypted_token(
  '3fe79b71-d5f6-4a66-b309-f6efa14cb2db',
  'oauth_refresh_token'
);
```
ê²°ê³¼: Refresh Token í‰ë¬¸ ë°˜í™˜ âœ…

**ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸**:
1. `/superadmin/api-management` ì ‘ì†
2. ê¸°ì¡´ í† í° ì„ íƒ
3. "Google ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ" í´ë¦­
4. Customer ëª©ë¡ ë“œë¡­ë‹¤ìš´ í‘œì‹œ âœ…

---

### ì˜í–¥ ë²”ìœ„

**ì˜í–¥ ì—†ìŒ**:
- **Meta Ads**: Vault ì‚¬ìš©, ì™„ì „íˆ ë‹¤ë¥¸ ì €ì¥/ì¡°íšŒ ë°©ì‹
- **ë°ì´í„° ìˆ˜ì§‘**: `collect-ad-data`ëŠ” ë³µí˜¸í™”ëœ í† í°ë§Œ ì‚¬ìš©
- **ê¸°ì¡´ ì•”í˜¸í™” ë°ì´í„°**: DBì— ì €ì¥ëœ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- **ì•”í˜¸í™” ë¡œì§**: `encrypt_oauth_tokens` í•¨ìˆ˜ëŠ” ìˆ˜ì •í•˜ì§€ ì•ŠìŒ

**ì˜í–¥ ìˆìŒ**:
- **Google Ads í† í° ë³µí˜¸í™”**: ë³µí˜¸í™” ë¡œì§ë§Œ ìˆ˜ì • (Base64 ë””ì½”ë”© ì¶”ê°€)

---

### ğŸš¨ ì ˆëŒ€ ì§€ì¼œì•¼ í•  ì›ì¹™

#### 1. ì•”í˜¸í™”/ë³µí˜¸í™” ëŒ€ì¹­ì„± ìœ ì§€
- **ì•”í˜¸í™” ì‹œ ì¸ì½”ë”©**: `encode(pgp_sym_encrypt(...), 'base64')`
- **ë³µí˜¸í™” ì‹œ ë””ì½”ë”©**: `pgp_sym_decrypt(decode(..., 'base64'), ...)`
- **ê·œì¹™**: ì•”í˜¸í™” ë‹¨ê³„ì™€ ë³µí˜¸í™” ë‹¨ê³„ê°€ **ì™„ì „íˆ ë°˜ëŒ€ ìˆœì„œ**ì—¬ì•¼ í•¨

**ì˜ëª»ëœ ì˜ˆ**:
```sql
-- ì•”í˜¸í™”: Base64 ì¸ì½”ë”© O
encode(pgp_sym_encrypt(token, key), 'base64')

-- ë³µí˜¸í™”: Base64 ë””ì½”ë”© X âŒ
pgp_sym_decrypt(encrypted_value, key)  -- ì—ëŸ¬ ë°œìƒ!
```

**ì˜¬ë°”ë¥¸ ì˜ˆ**:
```sql
-- ì•”í˜¸í™”: Base64 ì¸ì½”ë”© O
encode(pgp_sym_encrypt(token, key), 'base64')

-- ë³µí˜¸í™”: Base64 ë””ì½”ë”© O âœ…
pgp_sym_decrypt(decode(encrypted_value, 'base64'), key)
```

---

#### 2. ì•”í˜¸í™” í‚¤ ì¼ê´€ì„± ìœ ì§€
- **ì•”í˜¸í™” í‚¤**: `'your-encryption-key-change-this-in-production'`
- **ì‚¬ìš© ìœ„ì¹˜**:
  - `oauth-callback/index.ts` Line 209
  - `encrypt_oauth_tokens` RPC í•¨ìˆ˜
  - `get_decrypted_token` RPC í•¨ìˆ˜
- **ê·œì¹™**: ì„¸ ê³³ ëª¨ë‘ **ë™ì¼í•œ í‚¤** ì‚¬ìš©

**ë³€ê²½ ì‹œ ì£¼ì˜**:
```sql
-- âŒ ì˜ëª»ëœ ì˜ˆ: ì•”í˜¸í™” í‚¤ë§Œ ë³€ê²½
UPDATE í•¨ìˆ˜ SET encryption_key = 'new-key';

-- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: ì„¸ ê³³ ëª¨ë‘ ë™ì‹œì— ë³€ê²½
1. oauth-callback/index.ts Line 209
2. encrypt_oauth_tokens í•¨ìˆ˜
3. get_decrypted_token í•¨ìˆ˜
```

---

#### 3. ë°ì´í„° íƒ€ì… ì¼ì¹˜
- **DB ì €ì¥**: `TEXT` (Base64 ë¬¸ìì—´)
- **í•¨ìˆ˜ ë³€ìˆ˜**: `TEXT` (BYTEA ì•„ë‹˜)
- **ê·œì¹™**: ì €ì¥ íƒ€ì…ê³¼ ì¡°íšŒ íƒ€ì… **ì¼ì¹˜** í•„ìˆ˜

```sql
-- âŒ ì˜ëª»ëœ ì˜ˆ
DECLARE encrypted_value BYTEA;  -- DBëŠ” TEXTì¸ë° BYTEAë¡œ ì½ìŒ

-- âœ… ì˜¬ë°”ë¥¸ ì˜ˆ
DECLARE encrypted_value TEXT;  -- DBì™€ ë™ì¼í•œ íƒ€ì…
```

---

#### 4. RPC í•¨ìˆ˜ ìˆ˜ì • ì‹œ í…ŒìŠ¤íŠ¸ í•„ìˆ˜
- **ìˆ˜ì • í›„ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸**:
  ```sql
  SELECT get_decrypted_token('integration_id', 'oauth_refresh_token');
  ```
- **Edge Function í…ŒìŠ¤íŠ¸**: ë¡œì»¬ ë¡œê·¸ í™•ì¸
- **í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸**: ë¸Œëœë“œ ëª©ë¡ ì¡°íšŒ ê¸°ëŠ¥ í™•ì¸

---

#### 5. ê¸°ì¡´ ì‹œìŠ¤í…œ ì˜í–¥ ìµœì†Œí™”
- **ìˆ˜ì • ë²”ìœ„ ìµœì†Œí™”**: í•„ìš”í•œ í•¨ìˆ˜ë§Œ ìˆ˜ì •
- **Meta Ads ë¡œì§ ë³´ì¡´**: Vault ë°©ì‹ì€ ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€
- **í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€**: `api_tokens` í…Œì´ë¸” fallback ìœ ì§€

---

### ìµœì¢… ì •ë¦¬

| êµ¬ë¶„ | ì•”í˜¸í™” (ì €ì¥) | ë³µí˜¸í™” (ì¡°íšŒ) |
|------|-------------|-------------|
| **ê³¼ì •** | 1. pgp_sym_encrypt<br>2. encode(..., 'base64')<br>3. TEXTë¡œ ì €ì¥ | 1. TEXTë¡œ ì¡°íšŒ<br>2. decode(..., 'base64')<br>3. pgp_sym_decrypt |
| **íƒ€ì…** | TEXT | TEXT |
| **í‚¤** | 'your-encryption-key-change-this-in-production' | 'your-encryption-key-change-this-in-production' |

**í•µì‹¬**: ì•”í˜¸í™” 3ë‹¨ê³„ â†’ ë³µí˜¸í™” 3ë‹¨ê³„ (ì—­ìˆœ)
