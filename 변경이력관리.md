# ë³€ê²½ ì´ë ¥ ê´€ë¦¬ ì‹œìŠ¤í…œ

## ğŸ“‹ ì‹œìŠ¤í…œ ê°œìš”

ê´€ë¦¬ìì˜ ëª¨ë“  ì‘ì—… ì´ë ¥ì„ ì¶”ì í•˜ê³  ê¸°ë¡í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥
- **ìµœê·¼ 5ì¼ê°„** ê´€ë¦¬ì ì‘ì—… ì´ë ¥ ìë™ ê¸°ë¡
- ê¶Œí•œë³„ í•„í„°ë§ (Master/Agency/Brand)
- ë‚ ì§œ/íƒ€ì…/ì‘ì—…ë³„ í•„í„°ë§
- 5ì¼ ì´ˆê³¼ ì‹œ ìë™ ì‚­ì œ

### í˜ì´ì§€ ê²½ë¡œ
- **Superadmin**: `http://localhost:3000/superadmin/changelog`
- **Brandadmin**: `http://localhost:3000/brandadmin/changelog`

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### changelog í…Œì´ë¸”

```sql
CREATE TABLE changelog (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ëŒ€ìƒ ì •ë³´
  target_type TEXT NOT NULL CHECK (target_type IN ('user', 'token', 'brand', 'access', 'role')),
  target_id UUID,
  target_name TEXT,

  -- ì‘ì—… ì •ë³´
  action_type TEXT NOT NULL CHECK (action_type IN ('create', 'delete', 'update', 'invite')),
  action_detail TEXT NOT NULL,

  -- ë¸Œëœë“œ/ì¡°ì§ ì •ë³´
  advertiser_id UUID,
  advertiser_name TEXT,
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  organization_name TEXT,

  -- ì‘ì—… ìˆ˜í–‰ì ì •ë³´
  changed_by_id UUID NOT NULL,
  changed_by_name TEXT NOT NULL,
  changed_by_email TEXT NOT NULL,
  changed_by_role TEXT NOT NULL,

  -- ë³€ê²½ ì „í›„ ë°ì´í„° (ì„ íƒ)
  old_value JSONB,
  new_value JSONB,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### RLS ì •ì±…

- **Master**: ëª¨ë“  ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥
- **Agency**: ìì‹ ì˜ `organization_id` ë¡œê·¸ë§Œ ì¡°íšŒ
- **Brand**: ìì‹ ì˜ `advertiser_id` ë¡œê·¸ë§Œ ì¡°íšŒ

### ìë™ ì‚­ì œ

- **pg_cron** ìŠ¤ì¼€ì¤„: ë§¤ì¼ 02:00 KST (17:00 UTC)
- 5ì¼ ì´ˆê³¼ëœ ë ˆì½”ë“œ ìë™ ì‚­ì œ

---

## ğŸ“ ê¸°ë¡ë˜ëŠ” ì‘ì—…

### 1. ì‚¬ìš©ì ì‚­ì œ
**íŒŒì¼**: `src/views/admin/users/components/AdminDeleteUserModal.js`

```javascript
await logChangelog({
  targetType: 'user',
  targetId: targetUser.id,
  targetName: targetUser.name || targetUser.email,
  actionType: 'delete',
  actionDetail: `ì‚¬ìš©ì ì‚­ì œ: ${targetUser.name || targetUser.email} (${targetUser.email})`,
  advertiserId: targetUser.advertiser_id,
  advertiserName: targetUser.advertiser_name,
  organizationId: targetUser.organization_id,
  organizationName: targetUser.organization_name,
});
```

**í‘œì‹œ ì˜ˆì‹œ**: `ì‚¬ìš©ì ì‚­ì œ: í™ê¸¸ë™ (hong@example.com)`

---

### 2. í† í° ì¶”ê°€/ì‚­ì œ
**íŒŒì¼**: `src/views/superadmin/api-management/components/APITokenTable.js`

#### í† í° ì¶”ê°€
```javascript
await logChangelog({
  targetType: 'token',
  targetId: integrationId,
  targetName: `${platform} - ${accountDescription}`,
  actionType: 'create',
  actionDetail: `API í† í° ì¶”ê°€: ${platform} (ê³„ì •: ${accountDescription})`,
  advertiserId: advertiserId,
  advertiserName: advertiserName,
  organizationId: organizationId,
  organizationName: organizationName,
});
```

**í‘œì‹œ ì˜ˆì‹œ**: `API í† í° ì¶”ê°€: Meta Ads (ê³„ì •: ì‚¼ì„±ì „ì)`

#### í† í° ì‚­ì œ
```javascript
await logChangelog({
  targetType: 'token',
  targetId: tokenId,
  targetName: `${tokenData.platform} - ${tokenData.account_description}`,
  actionType: 'delete',
  actionDetail: `API í† í° ì‚­ì œ: ${tokenData.platform}`,
  advertiserId: tokenData.advertiser_id,
  advertiserName: tokenData.advertiser_name,
  organizationId: tokenData.organization_id,
  organizationName: tokenData.organization_name,
});
```

**í‘œì‹œ ì˜ˆì‹œ**: `API í† í° ì‚­ì œ: Google Ads`

---

### 3. ê¶Œí•œ ë³€ê²½
**íŒŒì¼**: `src/views/admin/users/components/EditUserModal.jsx`

```javascript
await logChangelog({
  targetType: 'role',
  targetId: user.id,
  targetName: user.name || user.email,
  actionType: 'update',
  actionDetail: `${user.name || user.email}ì˜ ê¶Œí•œ ë³€ê²½: ${getRoleLabel(user.role)} â†’ ${getRoleLabel(formData.role)}`,
  advertiserId: user.advertiser_id,
  organizationId: user.organization_id,
  oldValue: { role: user.role },
  newValue: { role: formData.role },
});
```

**í‘œì‹œ ì˜ˆì‹œ**: `í™ê¸¸ë™ì˜ ê¶Œí•œ ë³€ê²½: ì—ì´ì „ì‹œ ì§ì› â†’ ì—ì´ì „ì‹œ ê´€ë¦¬ì`

---

### 4. ì•¡ì„¸ìŠ¤ ìƒíƒœ ë³€ê²½
**íŒŒì¼**: `src/views/admin/users/components/UserTable.js`

```javascript
await logChangelog({
  targetType: 'access',
  targetId: userId,
  targetName: targetUser.name || targetUser.email,
  actionType: 'update',
  actionDetail: `${targetUser.name || targetUser.email}ì˜ ì•¡ì„¸ìŠ¤ ìƒíƒœ ë³€ê²½: ${currentAccess ? 'í—ˆìš©' : 'ì°¨ë‹¨'} â†’ ${newStatus === 'active' ? 'í—ˆìš©' : 'ì°¨ë‹¨'}`,
  advertiserId: targetUser.advertiser_id,
  organizationId: targetUser.organization_id,
  oldValue: { status: currentAccess ? 'active' : 'inactive' },
  newValue: { status: newStatus },
});
```

**í‘œì‹œ ì˜ˆì‹œ**: `í™ê¸¸ë™ì˜ ì•¡ì„¸ìŠ¤ ìƒíƒœ ë³€ê²½: í—ˆìš© â†’ ì°¨ë‹¨`

---

### 5. ì‚¬ìš©ì ì´ˆëŒ€
**íŒŒì¼**: `src/views/admin/users/components/InviteUserModal.jsx`

```javascript
await logChangelog({
  targetType: 'user',
  targetId: null,
  targetName: formData.email,
  actionType: 'invite',
  actionDetail: `ì‚¬ìš©ì ì´ˆëŒ€: ${formData.email} (ê¶Œí•œ: ${formData.role})`,
  advertiserId: formData.advertiserIds[0],
  organizationId: organizationId,
  newValue: {
    email: formData.email,
    role: formData.role
  },
});
```

**í‘œì‹œ ì˜ˆì‹œ**: `ì‚¬ìš©ì ì´ˆëŒ€: hong@example.com (ê¶Œí•œ: advertiser_staff)`

---

### 6. ë¸Œëœë“œ ì¶”ê°€/ì‚­ì œ
**íŒŒì¼**: ë¸Œëœë“œ ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸

```javascript
// ë¸Œëœë“œ ì¶”ê°€
await logChangelog({
  targetType: 'brand',
  targetId: advertiserId,
  targetName: advertiserName,
  actionType: 'create',
  actionDetail: `ë¸Œëœë“œ ì¶”ê°€: ${advertiserName}`,
  advertiserId: advertiserId,
  organizationId: organizationId,
});

// ë¸Œëœë“œ ì‚­ì œ
await logChangelog({
  targetType: 'brand',
  targetId: advertiserId,
  targetName: advertiserName,
  actionType: 'delete',
  actionDetail: `ë¸Œëœë“œ ì‚­ì œ: ${advertiserName}`,
  advertiserId: advertiserId,
  organizationId: organizationId,
});
```

**í‘œì‹œ ì˜ˆì‹œ**: `ë¸Œëœë“œ ì¶”ê°€: ì‚¼ì„±ì „ì`

---

## ğŸ¨ í˜ì´ì§€ êµ¬ì„±

### Superadmin í˜ì´ì§€

**ì»¬ëŸ¼ êµ¬ì¡°**:

| ë¸Œëœë“œ | ì´ë¦„ | ì´ë©”ì¼ | ë³€ê²½ì¼ | ë³€ê²½ë‚´ì—­ |
|--------|------|--------|--------|----------|
| ABC ì—ì´ì „ì‹œ | ê¹€ê´€ë¦¬ | admin@abc.com | 2026-01-27 14:30 | ğŸ”µ user ğŸŸ¢ create<br>ì‚¬ìš©ì ì´ˆëŒ€: hong@example.com |
| ì‚¼ì„±ì „ì | ì´ë‹´ë‹¹ | lee@samsung.com | 2026-01-27 13:15 | ğŸŸ  token ğŸ”´ delete<br>API í† í° ì‚­ì œ: Meta Ads |

### Brandadmin í˜ì´ì§€

**ì»¬ëŸ¼ êµ¬ì¡°** (ë¸Œëœë“œ ì»¬ëŸ¼ ì œì™¸):

| ì´ë¦„ | ì´ë©”ì¼ | ë³€ê²½ì¼ | ë³€ê²½ë‚´ì—­ |
|------|--------|--------|----------|
| ì´ë‹´ë‹¹ | lee@samsung.com | 2026-01-27 13:15 | ğŸŸ  token ğŸ”´ delete<br>API í† í° ì‚­ì œ: Meta Ads |
| ë°•ê´€ë¦¬ | park@samsung.com | 2026-01-26 15:20 | ğŸŸ¡ access ğŸ”µ update<br>í™ê¸¸ë™ì˜ ì•¡ì„¸ìŠ¤ ìƒíƒœ ë³€ê²½: í—ˆìš© â†’ ì°¨ë‹¨ |

### í•„í„° ê¸°ëŠ¥

- **ëŒ€ìƒ íƒ€ì…**: ì „ì²´ / ì‚¬ìš©ì / í† í° / ë¸Œëœë“œ / ì•¡ì„¸ìŠ¤ / ê¶Œí•œ
- **ì‘ì—… íƒ€ì…**: ì „ì²´ / ì¶”ê°€ / ì‚­ì œ / ë³€ê²½ / ì´ˆëŒ€
- **ë‚ ì§œ ë²”ìœ„**: ì‹œì‘ì¼ ~ ì¢…ë£Œì¼ (Calendar íŒì˜¤ë²„)
- **ì´ˆê¸°í™”**: ëª¨ë“  í•„í„° ë¦¬ì…‹

---

## ğŸ”§ ë°±ì—”ë“œ í•¨ìˆ˜

### logChangelog()

**íŒŒì¼**: `src/services/supabaseService.js`

```javascript
export async function logChangelog(logData) {
  try {
    const { data, error } = await supabase.rpc('log_changelog', {
      p_target_type: logData.targetType,
      p_target_id: logData.targetId,
      p_target_name: logData.targetName,
      p_action_type: logData.actionType,
      p_action_detail: logData.actionDetail,
      p_advertiser_id: logData.advertiserId || null,
      p_advertiser_name: logData.advertiserName || null,
      p_organization_id: logData.organizationId || null,
      p_organization_name: logData.organizationName || null,
      p_old_value: logData.oldValue || null,
      p_new_value: logData.newValue || null,
    });

    if (error) throw error;
    return data;
  } catch (error) {
    console.error('[logChangelog] Error:', error);
    return null; // ë¡œê·¸ ì‹¤íŒ¨ëŠ” ë©”ì¸ ì‘ì—…ì„ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•ŠìŒ
  }
}
```

**íŠ¹ì§•**:
- ë¡œê·¸ ì‹¤íŒ¨ ì‹œì—ë„ ë©”ì¸ ì‘ì—…ì€ ì„±ê³µ (try-catch ì²˜ë¦¬)
- ìë™ìœ¼ë¡œ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê¸°ë¡

### getChangelogs()

```javascript
export async function getChangelogs(filters = {}) {
  try {
    let query = supabase
      .from('changelog')
      .select('*', { count: 'exact' })
      .order('created_at', { ascending: false });

    if (filters.targetType) query = query.eq('target_type', filters.targetType);
    if (filters.actionType) query = query.eq('action_type', filters.actionType);
    if (filters.startDate) query = query.gte('created_at', filters.startDate);
    if (filters.endDate) query = query.lte('created_at', filters.endDate);

    const limit = filters.limit || 100;
    const offset = filters.offset || 0;
    query = query.range(offset, offset + limit - 1);

    const { data, error, count } = await query;
    if (error) throw error;

    return {
      changelogs: data || [],
      totalCount: count || 0,
    };
  } catch (error) {
    console.error('[getChangelogs] Error:', error);
    throw error;
  }
}
```

**íŠ¹ì§•**:
- RLS ìë™ ì ìš©ìœ¼ë¡œ ê¶Œí•œë³„ í•„í„°ë§
- í˜ì´ì§€ë„¤ì´ì…˜ ì§€ì› (ê¸°ë³¸ 100ê°œ)

---

## âš ï¸ ì¤‘ìš” ì‚¬í•­

### 1. SQL ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìˆ˜

íŒŒì¼: `supabase/migrations/042_changelog_system.sql`

ë°˜ë“œì‹œ Supabaseì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
# Supabase CLI
supabase db reset

# ë˜ëŠ” SQL Editorì—ì„œ ì§ì ‘ ì‹¤í–‰
```

### 2. ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨ ì²˜ë¦¬

ëª¨ë“  `logChangelog()` í˜¸ì¶œì€ ì´ë¯¸ try-catchë¡œ ê°ì‹¸ì ¸ ìˆì–´, ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨ ì‹œì—ë„ ë©”ì¸ ì‘ì—…ì€ ì •ìƒ ì™„ë£Œë©ë‹ˆë‹¤.

### 3. ê¶Œí•œ í•œê¸€í™”

ê¶Œí•œ ë³€ê²½ ë¡œê·¸ëŠ” ìë™ìœ¼ë¡œ í•œê¸€ë¡œ í‘œì‹œë©ë‹ˆë‹¤:
- `agency_staff` â†’ `ì—ì´ì „ì‹œ ì§ì›`
- `agency_manager` â†’ `ì—ì´ì „ì‹œ ê´€ë¦¬ì`
- `advertiser_admin` â†’ `ë¸Œëœë“œ ëŒ€í‘œìš´ì˜ì`
- ë“±ë“±

### 4. ë¸Œëœë“œ ì»¬ëŸ¼ í‘œì‹œ ë¡œì§

- **Agency ê³„ì •**: `organization_name` í‘œì‹œ
- **Advertiser ê³„ì •**: `advertiser_name` í‘œì‹œ

---

## ğŸ“‚ íŒŒì¼ êµ¬ì¡°

```
growth-dashboard/
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 042_changelog_system.sql          # DB ìŠ¤í‚¤ë§ˆ
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ supabaseService.js                # logChangelog, getChangelogs
â”‚   â”‚
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ superadmin/
â”‚   â”‚   â”‚   â””â”€â”€ changelog/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.jsx                 # Superadmin í˜ì´ì§€
â”‚   â”‚   â”‚       â””â”€â”€ components/
â”‚   â”‚   â”‚           â””â”€â”€ ChangelogTable.jsx    # í…Œì´ë¸” ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ brandadmin/
â”‚   â”‚   â”‚   â””â”€â”€ changelog/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.jsx                 # Brandadmin í˜ì´ì§€
â”‚   â”‚   â”‚       â””â”€â”€ ChangelogTable.jsx        # í…Œì´ë¸” ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ admin/users/components/
â”‚   â”‚       â”œâ”€â”€ AdminDeleteUserModal.js       # ì‚¬ìš©ì ì‚­ì œ ë¡œê·¸
â”‚   â”‚       â”œâ”€â”€ EditUserModal.jsx             # ê¶Œí•œ ë³€ê²½ ë¡œê·¸
â”‚   â”‚       â”œâ”€â”€ UserTable.js                  # ì•¡ì„¸ìŠ¤ ìƒíƒœ ë¡œê·¸
â”‚   â”‚       â””â”€â”€ InviteUserModal.jsx           # ì‚¬ìš©ì ì´ˆëŒ€ ë¡œê·¸
â”‚   â”‚
â”‚   â”œâ”€â”€ superadminRoutes.js                   # Superadmin ë¼ìš°íŠ¸
â”‚   â””â”€â”€ clientAdminRoutes.js                  # Brandadmin ë¼ìš°íŠ¸
```

---

## ğŸ› ë¬¸ì œ í•´ê²°

### í† í° ì‚­ì œê°€ ì•ˆë  ë•Œ

**ì›ì¸**: `logChangelog()` í•¨ìˆ˜ì—ì„œ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨

**í•´ê²°**:
1. SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í™•ì¸
2. `organizations` í…Œì´ë¸” ë°ì´í„° í™•ì¸
3. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸

### ë¡œê·¸ê°€ ì•ˆ ë³´ì¼ ë•Œ

**ì›ì¸**: RLS ì •ì±…ìœ¼ë¡œ ì¸í•œ í•„í„°ë§

**í™•ì¸**:
1. í˜„ì¬ ë¡œê·¸ì¸í•œ ê³„ì •ì˜ ê¶Œí•œ í™•ì¸
2. Master ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì„œ ì „ì²´ ë¡œê·¸ í™•ì¸
3. `organization_id`, `advertiser_id` ê°’ í™•ì¸

### ìë™ ì‚­ì œê°€ ì•ˆë  ë•Œ

**ì›ì¸**: pg_cron ìŠ¤ì¼€ì¤„ ë¯¸ë“±ë¡

**í•´ê²°**:
```sql
-- pg_cron ìŠ¤ì¼€ì¤„ í™•ì¸
SELECT * FROM cron.job WHERE jobname = 'cleanup-old-changelogs';

-- ì—†ìœ¼ë©´ ë‹¤ì‹œ ë“±ë¡
SELECT cron.schedule(
  'cleanup-old-changelogs',
  '0 17 * * *',
  $$SELECT cleanup_old_changelogs()$$
);
```

---

## ğŸ“Š ë°°ì§€ ìƒ‰ìƒ

### target_type (ëŒ€ìƒ íƒ€ì…)
- `user` - ğŸ”µ íŒŒë‘
- `token` - ğŸŸ  ì£¼í™©
- `brand` - ğŸŸ£ ë³´ë¼
- `access` - ğŸŸ¡ ë…¸ë‘
- `role` - ğŸŸ¢ ì´ˆë¡

### action_type (ì‘ì—… íƒ€ì…)
- `create` - ğŸŸ¢ ì´ˆë¡
- `delete` - ğŸ”´ ë¹¨ê°•
- `update` - ğŸ”µ íŒŒë‘
- `invite` - ğŸŸ£ ë³´ë¼

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

êµ¬í˜„ ì™„ë£Œ í•­ëª©:

- [x] ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (042_changelog_system.sql)
- [x] RLS ì •ì±… ì„¤ì •
- [x] ìë™ ì‚­ì œ í•¨ìˆ˜ ë° pg_cron ìŠ¤ì¼€ì¤„
- [x] `logChangelog()` ë°±ì—”ë“œ í•¨ìˆ˜
- [x] `getChangelogs()` ë°±ì—”ë“œ í•¨ìˆ˜
- [x] ì‚¬ìš©ì ì‚­ì œ ë¡œê·¸ í†µí•©
- [x] í† í° ì¶”ê°€/ì‚­ì œ ë¡œê·¸ í†µí•©
- [x] ê¶Œí•œ ë³€ê²½ ë¡œê·¸ í†µí•© (í•œê¸€í™”)
- [x] ì•¡ì„¸ìŠ¤ ìƒíƒœ ë³€ê²½ ë¡œê·¸ í†µí•© (í•œê¸€í™”)
- [x] ì‚¬ìš©ì ì´ˆëŒ€ ë¡œê·¸ í†µí•©
- [x] Superadmin í˜ì´ì§€ êµ¬í˜„
- [x] Brandadmin í˜ì´ì§€ êµ¬í˜„
- [x] í•„í„° ê¸°ëŠ¥ (DateRangePicker ë””ìì¸ ì ìš©)
- [x] í˜ì´ì§€ë„¤ì´ì…˜
- [x] ë¼ìš°íŠ¸ ì„¤ì • (ë‘ í˜ì´ì§€)

---

**ì‘ì„±ì¼**: 2026-01-27
**ì‘ì„±ì**: Claude Code
