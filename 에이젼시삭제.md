# 에이전시 삭제 기능 구현

**작성일**: 2026-02-02
**상태**: ✅ 구현 완료

---

## 목차

1. [기능 개요](#기능-개요)
2. [삭제 경로 및 권한](#삭제-경로-및-권한)
3. [데이터베이스 변경사항](#데이터베이스-변경사항)
4. [Edge Functions](#edge-functions)
5. [백엔드 함수](#백엔드-함수)
6. [프론트엔드 컴포넌트](#프론트엔드-컴포넌트)
7. [핵심 기술 결정사항](#핵심-기술-결정사항)
8. [문제 해결 과정](#문제-해결-과정)
9. [테스트 가이드](#테스트-가이드)

---

## 기능 개요

에이전시 조직 전체를 삭제하는 기능으로, 조직, 소속 브랜드, 모든 직원을 순차적으로 삭제합니다.

### 삭제 대상
- 에이전시 조직 (organizations)
- 소속된 모든 브랜드 (advertisers)
- 에이전시 직원 (users) - agency_admin, agency_staff, agency_manager
- 브랜드 전용 사용자 (advertiser_admin, advertiser_staff)
- 관련 데이터 (API 토큰, 광고 데이터, 수집 작업 등)

### 재가입 지원
- 이메일 익명화 패턴 사용: `deleted-{user_id}@deleted.local`
- 원래 이메일로 재가입 가능
- 참고: [회원가입_재가입.md](회원가입_재가입.md)

---

## 삭제 경로 및 권한

### 1. Master 권한 - 텍스트 확인만

**경로**: `/superadmin/advertisers`

**절차**:
1. 에이전시 조직 옆 3점 메뉴 클릭
2. "에이전시 삭제" 선택
3. 확인 문구 입력: `{조직명} 에이전시 삭제에 동의합니다`
4. 즉시 삭제 실행

**특징**:
- 이메일 인증 불필요
- 텍스트 확인만으로 삭제
- Master 권한만 접근 가능

### 2. Agency Admin - 이메일 인증 필수

**경로**: `/admin/profile` → 프로필 편집 모달

**절차**:
1. 프로필 편집 모달 열기
2. "에이전시 서비스 탈퇴" 섹션에서 "에이전시 삭제" 버튼 클릭
3. **1단계**: 확인 문구 입력 → "이메일로 확인 코드 발송" 버튼
4. **2단계**: 이메일에 포함된 6자리 코드 입력 → "확인 및 삭제" 버튼
5. 삭제 완료 후 자동 로그아웃

**특징**:
- 이메일 인증 필수 (2단계 인증)
- 본인 조직만 삭제 가능
- 로그아웃 후 재가입 가능

---

## 데이터베이스 변경사항

### 생성 파일
**[database/043_agency_deletion_verification.sql](database/043_agency_deletion_verification.sql)**

### 1. agency_deletion_codes 테이블

이메일 인증 코드 저장용 테이블:

```sql
CREATE TABLE IF NOT EXISTS agency_deletion_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  code TEXT NOT NULL UNIQUE,
  expires_at TIMESTAMPTZ NOT NULL,
  used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_agency_deletion_codes_org ON agency_deletion_codes(organization_id);
CREATE INDEX idx_agency_deletion_codes_user ON agency_deletion_codes(user_id);
CREATE INDEX idx_agency_deletion_codes_code ON agency_deletion_codes(code);
CREATE INDEX idx_agency_deletion_codes_expires ON agency_deletion_codes(expires_at);
```

**주요 필드**:
- `code`: 형식 `VERIFY-XXXXXX` (6자리 영숫자, 혼동 문자 제외)
- `expires_at`: 발급 후 10분 유효
- `used_at`: 사용 여부 추적 (NULL = 미사용)

### 2. RLS 정책

```sql
-- SELECT: 본인이 요청한 코드만 조회 가능
CREATE POLICY "Users can view their own agency deletion codes"
  ON agency_deletion_codes FOR SELECT
  USING (auth.uid() = user_id);

-- INSERT: 본인 코드만 생성 가능
CREATE POLICY "Users can create their own agency deletion codes"
  ON agency_deletion_codes FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- UPDATE: 본인 코드만 업데이트 가능
CREATE POLICY "Users can update their own agency deletion codes"
  ON agency_deletion_codes FOR UPDATE
  USING (auth.uid() = user_id);
```

### 3. CASCADE DELETE 확인

기존 FK 제약 조건 확인 필요:

```sql
-- organizations → advertisers: CASCADE (조직 삭제 시 브랜드도 삭제)
-- organizations → users: CASCADE (조직 삭제 시 직원도 삭제)
-- users → invitation_codes: CASCADE
-- advertisers → users (advertiser_id): SET NULL (브랜드 삭제 시 에이전시 직원 보호)
```

**중요**: `users.organization_id` FK는 **CASCADE DELETE**여야 조직 삭제 시 직원이 자동 삭제됩니다.

---

## Edge Functions

### 1. send-agency-deletion-email (신규)

**위치**: [supabase/functions/send-agency-deletion-email/index.ts](supabase/functions/send-agency-deletion-email/index.ts)

**기능**:
- 에이전시 삭제 확인 코드 생성 및 이메일 발송
- Resend API 사용

**코드 생성 로직**:

```typescript
// 혼동하기 쉬운 문자 제외: 0(숫자), O(문자), I(문자), 1(숫자), L(문자)
function generateVerificationCode(): string {
  const chars = '23456789ABCDEFGHJKMNPQRSTUVWXYZ';
  let code = 'VERIFY-';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}
```

**검증**:
- `agency_admin` 권한 확인
- 해당 조직 소유 여부 확인
- 기존 미사용 코드 삭제 (중복 방지)

**응답**:
```json
{
  "success": true,
  "expires_at": "2026-02-02T08:10:00.000Z",
  "message": "Verification code sent to email"
}
```

### 2. delete-user (수정)

**위치**: [supabase/functions/delete-user/index.ts](supabase/functions/delete-user/index.ts)

**추가 사항**: `is_agency_deletion` 플래그 지원

```typescript
interface DeleteUserRequest {
  user_id: string;
  new_owner_id?: string | null;
  is_brand_deletion?: boolean;
  is_agency_deletion?: boolean; // 추가
}
```

**변경 내용**:

1. **권한 체크 우회**:
   ```typescript
   if (!is_brand_deletion && !is_agency_deletion) {
     const authCheck = await canDeleteUser(supabaseAdmin, currentUser.id, user_id);
     if (!authCheck.canDelete) {
       return new Response(JSON.stringify({ error: authCheck.reason }), { status: 403 });
     }
   }
   ```

2. **조직 존재 체크 제거** (CASCADE 문제 해결):
   ```typescript
   // 에이전시 삭제 시에는 CASCADE DELETE로 인해 조직 삭제 후 자동 처리됨
   // 브랜드 삭제와 달리, 조직이 먼저 삭제되고 CASCADE로 users가 삭제되므로
   // 조직 존재 여부 체크를 하지 않음
   if (is_agency_deletion) {
     console.log('Agency deletion mode - skipping organization existence check');
   }
   ```

**삭제 순서**:
1. 이메일 익명화 (`deleted-{user_id}@deleted.local`)
2. auth.users 삭제
3. users 테이블 삭제 (CASCADE로 관련 데이터 자동 삭제)

---

## 백엔드 함수

**위치**: [src/services/supabaseService.js](src/services/supabaseService.js)

### 1. sendAgencyDeletionEmail

```javascript
export const sendAgencyDeletionEmail = async (organizationId, organizationName) => {
  const { data: { session } } = await supabase.auth.getSession();
  const functionUrl = `${SUPABASE_URL}/functions/v1/send-agency-deletion-email`;

  const response = await fetch(functionUrl, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${session.access_token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      organization_id: organizationId,
      organization_name: organizationName,
    }),
  });

  return await response.json();
};
```

### 2. verifyAgencyDeletionCode

```javascript
export const verifyAgencyDeletionCode = async (code, organizationId) => {
  const { data, error } = await supabase
    .from('agency_deletion_codes')
    .select('*')
    .eq('code', code)
    .eq('organization_id', organizationId)
    .is('used_at', null)
    .single();

  if (error) {
    return { valid: false, reason: '유효하지 않은 코드입니다.' };
  }

  // 만료 확인
  const expiresAt = new Date(data.expires_at);
  const now = new Date();
  if (now > expiresAt) {
    return { valid: false, reason: '코드가 만료되었습니다. 새 코드를 발급받으세요.' };
  }

  // 사용 처리
  await supabase
    .from('agency_deletion_codes')
    .update({ used_at: now.toISOString() })
    .eq('id', data.id);

  return { valid: true };
};
```

### 3. deleteAgency (핵심 함수)

**삭제 순서 (매우 중요!)**:

```javascript
export const deleteAgency = async (organizationId, organizationName) => {
  // 1. 조직 정보 조회 (브랜드 목록 포함)
  const { data: orgData } = await supabase
    .from('organizations')
    .select('id, name, advertisers(id, name)')
    .eq('id', organizationId)
    .single();

  // 2. 소속 브랜드 모두 삭제 (deleteBrand 함수 재사용)
  for (const brand of orgData.advertisers) {
    await deleteBrand(brand.id, brand.name);
  }

  // 3. 에이전시 직원 목록 조회
  const { data: usersToDelete } = await supabase
    .from('users')
    .select('id, email, name, role')
    .eq('organization_id', organizationId);

  // 4. 에이전시 직원들 삭제 먼저 (조직 삭제 전에!)
  // 이유: 조직 삭제 시 CASCADE로 users 삭제되면 현재 사용자도 삭제되어 인증 실패
  const { data: { session } } = await supabase.auth.getSession();
  const functionUrl = `${SUPABASE_URL}/functions/v1/delete-user`;

  // 현재 로그인한 사용자를 마지막에 삭제
  const currentUserId = session.user.id;
  const otherUsers = usersToDelete.filter(u => u.id !== currentUserId);
  const currentUser = usersToDelete.find(u => u.id === currentUserId);
  const orderedUsers = currentUser ? [...otherUsers, currentUser] : usersToDelete;

  for (const user of orderedUsers) {
    await fetch(functionUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_id: user.id,
        is_agency_deletion: false  // 조직 아직 존재하므로 false
      }),
    });
  }

  // 5. 조직 삭제 (사용자 삭제 후에!)
  await supabase
    .from('organizations')
    .delete()
    .eq('id', organizationId);
};
```

**삭제 순서 요약**:
```
브랜드 삭제 → 직원 조회 → 직원 삭제 → 조직 삭제
```

### 4. canDeleteAgency

```javascript
export const canDeleteAgency = async (organizationId) => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return { canDelete: false, reason: '로그인이 필요합니다.' };

  const { data: userData } = await supabase
    .from('users')
    .select('role, organization_id')
    .eq('id', session.user.id)
    .single();

  // Master 권한 또는 해당 조직의 agency_admin
  if (userData.role === 'master') {
    return { canDelete: true };
  }

  if (userData.role === 'agency_admin' && userData.organization_id === organizationId) {
    return { canDelete: true };
  }

  return { canDelete: false, reason: '권한이 없습니다.' };
};
```

---

## 프론트엔드 컴포넌트

### 1. DeleteAgencyModal (Master용)

**위치**: [src/views/superadmin/advertisers/components/DeleteAgencyModal.jsx](src/views/superadmin/advertisers/components/DeleteAgencyModal.jsx)

**특징**:
- 텍스트 확인만으로 삭제
- 브랜드 삭제 모달(DeleteBrandModal) 패턴 재사용

**확인 문구**:
```javascript
const expectedText = `${organization?.name} 에이전시 삭제에 동의합니다`;
```

**주요 코드**:
```jsx
<Input
  value={confirmText}
  onChange={(e) => setConfirmText(e.target.value)}
  placeholder="위 문구를 정확히 입력하세요"
/>
<Button
  colorScheme="red"
  onClick={handleConfirm}
  isDisabled={!isConfirmValid || isLoading}
  isLoading={isLoading}
>
  삭제
</Button>
```

### 2. DeleteAgencyWithEmailModal (Agency Admin용)

**위치**: [src/views/admin/profile/components/DeleteAgencyWithEmailModal.jsx](src/views/admin/profile/components/DeleteAgencyWithEmailModal.jsx)

**특징**:
- 2단계 인증 (텍스트 확인 → 이메일 코드 입력)
- PinInput 컴포넌트 사용 (6자리)

**단계별 UI**:

**1단계 - 텍스트 확인**:
```jsx
{step === 'confirm' && (
  <>
    <Text>확인 문구를 입력하세요:</Text>
    <Text fontWeight="600" color="red.500">
      {expectedText}
    </Text>
    <Input
      value={confirmText}
      onChange={(e) => setConfirmText(e.target.value)}
    />
    <Button onClick={handleSendEmail} isDisabled={!isConfirmValid}>
      이메일로 확인 코드 발송
    </Button>
  </>
)}
```

**2단계 - 코드 입력**:
```jsx
{step === 'code' && (
  <>
    <Alert status="info">
      {user?.email}로 확인 코드를 발송했습니다.
    </Alert>
    <Text>
      이메일에 포함된 <strong>VERIFY-XXXXXX</strong> 형식의 코드에서<br />
      하이픈 뒤 <strong>6자리 숫자/문자</strong>만 입력하세요.
    </Text>
    <PinInput
      value={verificationCode}
      onChange={setVerificationCode}
      size="lg"
      type="alphanumeric"
    >
      <PinInputField />
      <PinInputField />
      <PinInputField />
      <PinInputField />
      <PinInputField />
      <PinInputField />
    </PinInput>
    <Button onClick={handleVerifyAndDelete}>
      확인 및 삭제
    </Button>
  </>
)}
```

**검증 및 삭제 로직**:
```javascript
const handleVerifyAndDelete = async () => {
  // 코드 검증
  const codeWithPrefix = `VERIFY-${verificationCode}`;
  const verifyResult = await verifyAgencyDeletionCode(codeWithPrefix, organization.id);

  if (!verifyResult.valid) {
    toast({ title: '코드 검증 실패', description: verifyResult.reason });
    return;
  }

  // 삭제 실행
  await deleteAgency(organization.id, organization.name);

  // 로그아웃
  await signOut();
  navigate('/auth/sign-in');
};
```

### 3. superadmin/advertisers 페이지 수정

**위치**: [src/views/superadmin/advertisers/index.jsx](src/views/superadmin/advertisers/index.jsx)

**추가 사항**:
```javascript
// State
const [selectedOrganizationForDelete, setSelectedOrganizationForDelete] = useState(null);

// Handler
const handleDeleteAgency = (organization) => {
  setSelectedOrganizationForDelete(organization);
  onDeleteAgencyOpen();
};

const confirmDeleteAgency = async (organizationId) => {
  await deleteAgency(organizationId, selectedOrganizationForDelete.name);
  toast({ title: "에이전시 삭제 완료" });
  fetchOrganizations();
  onDeleteAgencyClose();
};

// JSX
<DeleteAgencyModal
  isOpen={isDeleteAgencyOpen}
  onClose={onDeleteAgencyClose}
  organization={selectedOrganizationForDelete}
  onConfirm={confirmDeleteAgency}
/>
```

### 4. AdvertisersTree 컴포넌트 수정

**위치**: [src/views/superadmin/advertisers/components/AdvertisersTree.jsx](src/views/superadmin/advertisers/components/AdvertisersTree.jsx)

**조직 헤더에 삭제 버튼 추가**:
```jsx
const canDeleteAgency = () => {
  return role === 'master';
};

{canDeleteAgency() && (
  <Menu>
    <MenuButton as={IconButton} icon={<Icon as={MdMoreVert} />} size="sm" />
    <MenuList>
      <MenuItem
        icon={<Icon as={MdDelete} />}
        color="red.500"
        onClick={() => onDeleteAgency(org)}
      >
        에이전시 삭제
      </MenuItem>
    </MenuList>
  </Menu>
)}
```

### 5. ProfileEditModal 수정

**위치**: [src/views/admin/profile/components/ProfileEditModal.js](src/views/admin/profile/components/ProfileEditModal.js)

**추가 사항**:

1. **Import 및 State**:
```javascript
import DeleteAgencyWithEmailModal from './DeleteAgencyWithEmailModal';

const { user, role, advertiserId, organizationId, signOut } = useAuth();
const [currentOrganization, setCurrentOrganization] = useState(null);
const isAgencyAdmin = role === 'agency_admin';

const { isOpen: isDeleteAgencyOpen, onOpen: onDeleteAgencyOpen, onClose: onDeleteAgencyClose } = useDisclosure();
```

2. **조직 정보 조회 useEffect**:
```javascript
React.useEffect(() => {
  const fetchOrganizationInfo = async () => {
    if (isAgencyAdmin && organizationId) {
      const { data, error } = await supabase
        .from('organizations')
        .select(`
          id,
          name,
          type,
          advertisers (id, name)
        `)
        .eq('id', organizationId)
        .single();

      if (error) throw error;
      setCurrentOrganization(data);
    }
  };

  if (isOpen) {
    fetchOrganizationInfo();
  }
}, [isOpen, isAgencyAdmin, organizationId]);
```

3. **UI 섹션**:
```jsx
{/* 에이전시 삭제 섹션 (agency_admin만) */}
{isAgencyAdmin && currentOrganization && (
  <>
    <Divider my={2} />
    <VStack align="stretch" spacing={2}>
      <Text fontSize="sm" fontWeight="500" color="red.700">
        에이전시 서비스 탈퇴
      </Text>
      <Button
        leftIcon={<MdDelete />}
        colorScheme="red"
        size="sm"
        onClick={onDeleteAgencyOpen}
      >
        에이전시 삭제
      </Button>
      <Text fontSize="xs" color="red.500">
        조직, 소속 브랜드({currentOrganization.advertisers?.length || 0}개), 모든 직원 및 데이터가 영구 삭제됩니다.
      </Text>
    </VStack>
  </>
)}
```

4. **모달 렌더링**:
```jsx
{/* 에이전시 삭제 확인 모달 */}
{currentOrganization && (
  <DeleteAgencyWithEmailModal
    isOpen={isDeleteAgencyOpen}
    onClose={onDeleteAgencyClose}
    organization={currentOrganization}
  />
)}
```

---

## 핵심 기술 결정사항

### 1. 삭제 순서 - 브랜드 vs 에이전시

#### 브랜드 삭제 순서
```
사용자 조회 → 브랜드 삭제 → 사용자 삭제
```
**이유**: RLS 정책이 `auth.uid()`의 users 테이블 존재 여부를 체크하므로, 사용자를 먼저 삭제하면 브랜드 삭제가 실패

**참고**: [브랜드삭제_오류.md](브랜드삭제_오류.md)

#### 에이전시 삭제 순서
```
브랜드 삭제 → 사용자 조회 → 사용자 삭제 → 조직 삭제
```
**이유**:
1. 조직 삭제 시 CASCADE로 users가 자동 삭제됨
2. 현재 로그인 사용자도 CASCADE 삭제되면 Edge Function 인증 실패
3. 따라서 users를 먼저 삭제하고 조직은 마지막에 삭제

### 2. is_agency_deletion 플래그의 역할 변화

**초기 설계**: 조직이 이미 삭제되었음을 나타내는 보안 플래그
- Edge Function에서 조직 존재 여부 체크
- 조직이 아직 존재하면 에러 반환

**문제**: CASCADE DELETE와 충돌
- 조직 삭제 → CASCADE로 users 삭제 → Edge Function에서 users를 찾을 수 없음

**최종 결정**: 플래그를 `false`로 설정하고 조직 존재 체크 제거
- 삭제 순서를 변경: users 먼저 삭제 → 조직 나중에 삭제
- `is_agency_deletion` 플래그는 현재 사용하지 않지만, 향후 확장성을 위해 보존

### 3. 이메일 인증 코드 문자 선택

**문제**: 숫자 `0`과 문자 `O`, 숫자 `1`과 문자 `I/L` 구분 어려움

**해결**: 혼동하기 쉬운 문자 제외
```typescript
// 제외: 0, O, I, 1, L
const chars = '23456789ABCDEFGHJKMNPQRSTUVWXYZ';
```

### 4. PinInput 설정

**문제**: 기본 PinInput은 숫자만 입력 가능

**해결**: `type="alphanumeric"` 속성 추가
```jsx
<PinInput type="alphanumeric">
```

### 5. AuthContext와 organizationId

**문제**: ProfileEditModal에서 `user?.organization_id` 접근 시 undefined

**원인**: AuthContext는 `user` (Supabase auth user)와 `organizationId` (별도 필드)를 분리하여 제공

**해결**:
```javascript
const { user, organizationId } = useAuth();
// user.organization_id 대신 organizationId 사용
```

---

## 문제 해결 과정

### 1. 401 Unauthorized 에러

**증상**:
```
POST /functions/v1/delete-user 401 (Unauthorized)
[deleteAgency] ✗ test@zestdot.com 삭제 실패: {error: 'Unauthorized'}
```

**원인**:
- 조직 삭제 → CASCADE로 users 삭제 → 현재 사용자도 삭제됨
- Edge Function 호출 시 인증 실패 (users 테이블에 사용자 없음)

**해결**:
```javascript
// 변경 전: 조직 삭제 → 사용자 삭제 (❌)
await supabase.from('organizations').delete().eq('id', organizationId);
await fetch(deleteUserUrl, ...);

// 변경 후: 사용자 삭제 → 조직 삭제 (✅)
await fetch(deleteUserUrl, ...);
await supabase.from('organizations').delete().eq('id', organizationId);
```

### 2. 코드 검증 실패 (Cannot coerce result)

**증상**:
```
[verifyAgencyDeletionCode] 조회 에러: {code: 'PGRST116', details: 'The result contains 0 rows'}
```

**원인**:
- DB: `VERIFY-AZD29O` (문자 O)
- 입력: `VERIFY-AZD290` (숫자 0)
- 폰트에서 구분 어려움

**해결**: 코드 생성 시 혼동 문자 제외
```typescript
const chars = '23456789ABCDEFGHJKMNPQRSTUVWXYZ'; // 0, O, I, 1, L 제외
```

### 3. 에이전시 삭제 섹션 미표시

**증상**: `/admin/profile`에서 에이전시 삭제 옵션이 보이지 않음

**원인**: `user?.organization_id` undefined (AuthContext는 별도 필드로 제공)

**해결**:
```javascript
// 변경 전
const { user, role } = useAuth();
if (isAgencyAdmin && user?.organization_id) { ... }

// 변경 후
const { user, role, organizationId } = useAuth();
if (isAgencyAdmin && organizationId) { ... }
```

### 4. PinInput 입력 불가

**증상**: 이메일 코드 입력 시 문자 입력 안 됨

**원인**: PinInput 기본값은 숫자만 허용

**해결**:
```jsx
<PinInput type="alphanumeric"> {/* 추가 */}
```

---

## 테스트 가이드

### 사전 준비

1. **테스트 계정 생성**:
   ```sql
   -- database/create_test_accounts.sql 실행
   -- 에이전시 조직 + agency_admin + 브랜드 + advertiser_admin 생성
   ```

2. **환경 변수 확인**:
   - `RESEND_API_KEY`: 이메일 발송용 (send-agency-deletion-email)

3. **Edge Functions 배포 확인**:
   ```bash
   SUPABASE_ACCESS_TOKEN=your_token npx supabase@latest functions deploy send-agency-deletion-email --project-ref your_project_ref
   SUPABASE_ACCESS_TOKEN=your_token npx supabase@latest functions deploy delete-user --project-ref your_project_ref
   ```

### 테스트 시나리오 1: Master 권한 삭제

1. Master 계정으로 로그인
2. `/superadmin/advertisers` 접속
3. 테스트 에이전시 조직 옆 3점 메뉴 클릭
4. "에이전시 삭제" 선택
5. 확인 문구 입력: `{조직명} 에이전시 삭제에 동의합니다`
6. "삭제" 버튼 클릭

**예상 결과**:
- 브라우저 콘솔에서 삭제 프로세스 확인
  ```
  [deleteAgency] 삭제 시작
  [deleteBrand] 브랜드 삭제 중: {브랜드명}
  [deleteAgency] 직원 삭제 중: {이메일}
  [deleteAgency] ✓ 조직 삭제 완료
  ```
- 에이전시 목록에서 제거됨
- 데이터베이스 검증:
  ```sql
  -- 조직 확인 (0 rows 예상)
  SELECT * FROM organizations WHERE name = '테스트 에이전시';

  -- 브랜드 확인 (0 rows 예상)
  SELECT * FROM advertisers WHERE name = '테스트 브랜드';

  -- 사용자 확인 (0 rows 예상)
  SELECT * FROM users WHERE email IN ('agency.admin@test.com', 'brand.admin@test.com');

  -- auth.users 확인 (0 rows 예상)
  SELECT * FROM auth.users WHERE email IN ('agency.admin@test.com', 'brand.admin@test.com');
  ```

### 테스트 시나리오 2: Agency Admin 이메일 인증

1. Agency Admin 계정으로 로그인 (`agency.admin@test.com`)
2. `/admin/profile` 접속
3. 프로필 편집 버튼 클릭
4. "에이전시 서비스 탈퇴" 섹션 확인
5. "에이전시 삭제" 버튼 클릭

**1단계: 텍스트 확인**
6. 확인 문구 입력: `{조직명} 삭제에 동의합니다`
7. "이메일로 확인 코드 발송" 버튼 클릭
8. 이메일 수신 확인 (제목: "에이전시 삭제 확인 코드")

**2단계: 코드 입력**
9. 이메일의 `VERIFY-XXXXXX` 코드 확인
10. 하이픈 뒤 6자리만 입력 (예: `A2B3C4`)
11. "확인 및 삭제" 버튼 클릭

**예상 결과**:
- 삭제 완료 메시지 표시
- 자동 로그아웃
- 로그인 페이지로 리다이렉트
- 데이터베이스에서 조직, 브랜드, 모든 사용자 삭제 확인 (위 쿼리 사용)

### 테스트 시나리오 3: 재가입

1. 삭제된 이메일로 새 초대 코드 발급
2. 회원가입 진행
3. **예상 결과**: 성공 (이메일 익명화로 UNIQUE 제약 해제됨)

### 브라우저 콘솔 로그 확인

**정상 흐름**:
```
[deleteAgency] 삭제 시작: {organizationId, organizationName}
[deleteAgency] 조직 정보: {...}
[deleteAgency] 소속 브랜드 수: 1
[deleteBrand] 삭제 시작: {brandId, brandName}
[deleteBrand] 삭제할 사용자: 1 [...]
[deleteBrand] ✓ 브랜드 삭제 완료
[deleteBrand] 사용자 삭제 중: test@example.com
[deleteBrand] ✓ test@example.com 삭제 완료
[deleteAgency] ✓ 브랜드 삭제 완료: {브랜드명}
[deleteAgency] 브랜드 삭제 완료: {total: 1, success: 1, failed: 0}
[deleteAgency] 삭제할 직원: 2 [...]
[deleteAgency] 삭제 순서: ['user1@test.com ', 'user2@test.com (현재 사용자)']
[deleteAgency] 직원 삭제 중: user1@test.com
[deleteAgency] ✓ user1@test.com 삭제 완료
[deleteAgency] 직원 삭제 중: user2@test.com
[deleteAgency] ✓ user2@test.com 삭제 완료
[deleteAgency] 직원 삭제 완료: {total: 2, success: 2, failed: 0}
[deleteAgency] ✓ 조직 삭제 완료
[deleteAgency] 삭제 완료: {...}
```

### 에러 시나리오 테스트

1. **만료된 코드 입력**:
   - 코드 발급 후 10분 경과
   - 예상: "코드가 만료되었습니다" 메시지

2. **잘못된 코드 입력**:
   - 존재하지 않는 코드 입력
   - 예상: "유효하지 않은 코드입니다" 메시지

3. **권한 없는 사용자**:
   - Agency Staff 계정으로 로그인
   - 예상: 에이전시 삭제 섹션 미표시

4. **다른 조직의 코드 입력**:
   - A 조직 관리자가 B 조직 코드 입력
   - 예상: "유효하지 않은 코드입니다" 메시지

---

## 관련 문서

- [브랜드삭제_오류.md](브랜드삭제_오류.md) - RLS 정책과 삭제 순서 문제
- [브랜드삭제기능.md](브랜드삭제기능.md) - 브랜드 삭제 기능 구현
- [회원가입_재가입.md](회원가입_재가입.md) - 이메일 익명화 패턴
- [database/042_brand_deletion_constraints.sql](database/042_brand_deletion_constraints.sql) - FK 제약 조건

---

## 배포 체크리스트

- [x] 데이터베이스 마이그레이션 실행 (043_agency_deletion_verification.sql)
- [x] Edge Functions 배포
  - [x] send-agency-deletion-email
  - [x] delete-user (수정)
- [x] Resend API 키 설정 확인
- [x] 프론트엔드 빌드 및 배포
- [x] 테스트 계정 생성
- [x] Master 권한 삭제 테스트
- [x] Agency Admin 이메일 인증 테스트
- [x] 재가입 테스트

---

## 주의사항

### ⚠️ 데이터 복구 불가능
- 에이전시 삭제는 **영구적**이며 **복구 불가능**
- 조직, 브랜드, 사용자, 광고 데이터 모두 삭제
- 사용자 삭제 로그는 `user_deletion_log` 테이블에 기록됨

### ⚠️ CASCADE DELETE 주의
- `users.organization_id` FK는 CASCADE DELETE 필수
- `users.advertiser_id` FK는 SET NULL (에이전시 직원 보호)
- FK 제약 조건 변경 시 삭제 순서 재검토 필요

### ⚠️ 삭제 순서 엄수
- **에이전시**: 브랜드 → 사용자 → 조직
- **브랜드**: 사용자 조회 → 브랜드 → 사용자
- 순서 변경 시 RLS 정책 또는 인증 문제 발생 가능

### ⚠️ Edge Function 권한
- Service Role Key 필요 (auth.users 삭제)
- 브라우저에서 절대 Service Role Key 노출 금지
- Edge Function을 통해서만 auth.users 삭제

### ⚠️ 이메일 발송
- Resend API 키 필요
- 이메일 발송 실패 시 코드가 생성되지 않음
- 프로덕션 환경에서는 발송 제한 확인

---

**작성일**: 2026-02-02
**최종 수정**: 2026-02-02
**작성자**: Claude Sonnet 4.5
