# 회원탈퇴 기능 구현

## 작업 개요
사용자 계정 삭제(회원탈퇴) 기능 구현 및 브랜드 대표자 소유권 이전 기능 추가

**작업 기간**: 2026-01-26
**상태**: 완료 (Edge Function 배포 권한 이슈로 수동 배포 필요)

---

## 요구사항

### 기본 요구사항
- `/admin/profile` 페이지에 "회원탈퇴" 버튼 추가
- 사용자 탈퇴 시 사용자 데이터 삭제
- 브랜드 소유 API 토큰은 보존 (계속 사용 가능)
- 게시글은 보존하되 작성자 정보는 제거
- 광고 크리에이티브는 브랜드와 함께 삭제

### 특수 케이스
1. **브랜드 대표자 (advertiser_admin)**
   - 탈퇴 전 다른 사용자에게 소유권 이전 필수
   - 브랜드에 다른 사용자가 없으면 탈퇴 불가
   - 향후 "브랜드 삭제" 기능 제공 예정

2. **Master 계정**
   - 삭제 불가

---

## 구현 내용

### 1. 데이터베이스 마이그레이션

**파일**: `database/041_user_deletion_constraints.sql`

#### 주요 변경사항
```sql
-- 1. api_tokens 보호 (CASCADE → SET NULL)
ALTER TABLE api_tokens ALTER COLUMN advertiser_id DROP NOT NULL;
ALTER TABLE api_tokens ADD COLUMN IF NOT EXISTS deleted_advertiser_name TEXT;
ALTER TABLE api_tokens
  DROP CONSTRAINT IF EXISTS api_tokens_advertiser_id_fkey,
  ADD CONSTRAINT api_tokens_advertiser_id_fkey
    FOREIGN KEY (advertiser_id) REFERENCES advertisers(id) ON DELETE SET NULL;

-- 2. ad_creatives 삭제 허용 (RESTRICT → CASCADE)
ALTER TABLE ad_creatives
  DROP CONSTRAINT IF EXISTS ad_creatives_advertiser_id_fkey,
  ADD CONSTRAINT ad_creatives_advertiser_id_fkey
    FOREIGN KEY (advertiser_id) REFERENCES advertisers(id) ON DELETE CASCADE;

-- 3. 감사 로그 테이블 생성
CREATE TABLE IF NOT EXISTS user_deletion_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  deleted_user_id UUID NOT NULL,
  deleted_user_email TEXT NOT NULL,
  deleted_user_name TEXT,
  deleted_by_user_id UUID,
  advertiser_id UUID,
  organization_id UUID,
  new_advertiser_admin_id UUID,
  deletion_reason TEXT,
  data_snapshot JSONB,
  deleted_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 실행 방법
Supabase Dashboard → SQL Editor에서 전체 SQL 파일 실행

---

### 2. Edge Functions

#### 2.1 get-brand-users (브랜드 사용자 조회)

**파일**: `supabase/functions/get-brand-users/index.ts`

**목적**: 소유권 이전을 위한 브랜드 내 다른 사용자 목록 조회

**주요 로직**:
- `user_advertisers` 테이블에서 동일 브랜드 사용자 조회
- 현재 사용자 제외
- `advertiser_admin` 역할 필터링 (중복 방지)

**요청 형식**:
```json
{
  "advertiser_id": "브랜드 ID",
  "exclude_user_id": "제외할 사용자 ID"
}
```

**응답 형식**:
```json
{
  "success": true,
  "users": [
    {
      "id": "user-id",
      "name": "사용자명",
      "email": "email@example.com",
      "role": "advertiser_staff"
    }
  ],
  "count": 1
}
```

#### 2.2 delete-user (사용자 삭제)

**파일**: `supabase/functions/delete-user/index.ts`

**목적**: 사용자 계정 삭제 및 소유권 이전 처리

**주요 기능**:
1. 본인 계정만 삭제 가능 확인
2. 브랜드 대표자인 경우 소유권 이전
3. 감사 로그 기록
4. 사용자 데이터 삭제 (CASCADE)

**요청 형식**:
```json
{
  "user_id": "삭제할 사용자 ID",
  "new_owner_id": "새 브랜드 대표자 ID (선택)"
}
```

#### 배포 명령어
```bash
npx supabase functions deploy get-brand-users --project-ref xqtaxjhvflictteppmzi
npx supabase functions deploy delete-user --project-ref xqtaxjhvflictteppmzi
```

**상태**: ❌ 배포 권한 부족으로 수동 배포 필요

---

### 3. 프론트엔드 구현

#### 3.1 서비스 함수 추가

**파일**: `src/services/supabaseService.js` (라인 2892-2961)

**추가된 함수**:
```javascript
// 브랜드 사용자 목록 조회
export const getBrandUsersForTransfer = async (advertiserId, excludeUserId)

// 사용자 계정 삭제
export const deleteUserAccount = async (userId, newOwnerId = null)

// 삭제 가능 여부 확인
export const canDeleteUser = (user)
```

#### 3.2 UI 컴포넌트

##### DeleteAccountConfirmModal.js (신규)
**파일**: `src/views/admin/profile/components/DeleteAccountConfirmModal.js`

**기능**:
- 최종 확인 모달
- "회원탈퇴" 문자열 입력 확인
- 삭제될 데이터와 보존될 데이터 안내
- 삭제 후 자동 로그아웃 및 리다이렉트

**주요 UI**:
- 경고 메시지
- 확인 입력란
- 삭제/보존 데이터 목록
- 취소/확인 버튼

##### OwnershipTransferModal.js (신규)
**파일**: `src/views/admin/profile/components/OwnershipTransferModal.js`

**기능**:
- 브랜드 대표자용 소유권 이전 모달
- 브랜드 내 다른 사용자 목록 표시
- 새 대표자 선택
- 다른 사용자가 없을 경우 안내

**주요 UI**:
- 사용자 목록 (RadioGroup)
- 로딩 스피너
- 경고 알림
- "브랜드 삭제" 버튼 (비활성화, 향후 구현)

##### ProfileEditModal.js (수정)
**파일**: `src/views/admin/profile/components/ProfileEditModal.js`

**변경사항**:
1. `advertiserId` 가져오기 (AuthContext)
2. 모달 상태 관리 추가
3. "위험 영역" 섹션 추가
4. "회원탈퇴" 버튼 추가
5. 역할별 모달 플로우 구현

**코드 변경**:
```javascript
// Line 33: advertiserId 추가
const { user, role, advertiserId } = useAuth();

// Line 315: advertiser_id 포함하여 전달
currentUser={{ ...user, advertiser_id: advertiserId }}
```

---

## 트러블슈팅

### 문제: 브랜드 사용자 목록 조회 실패

**증상**:
브랜드 대표자가 회원탈퇴 버튼 클릭 시 소유권 이전 모달에서 사용자 목록이 로드되지 않음

**원인**:
- `AuthContext`의 `user` 객체에 `advertiser_id` 속성이 없음
- `advertiserId`가 별도 변수로 제공됨

**해결**:
1. `ProfileEditModal`에서 `advertiserId` 가져오기
2. `OwnershipTransferModal`에 `advertiser_id` 포함한 객체 전달
3. 디버깅 로그 추가

**수정된 파일**:
- `src/views/admin/profile/components/ProfileEditModal.js` (Line 33, 315)
- `src/views/admin/profile/components/OwnershipTransferModal.js` (Line 51-61, 75-78)
- `supabase/functions/get-brand-users/index.ts` (Line 51-63, 88-101)

---

## 테스트 방법

### 1. 일반 사용자 탈퇴
1. 일반 사용자(advertiser_staff, viewer 등)로 로그인
2. 프로필 페이지에서 프로필 편집 클릭
3. "회원탈퇴" 버튼 클릭
4. 삭제 확인 모달에서 "회원탈퇴" 입력
5. 계정 삭제 및 로그아웃 확인

### 2. 브랜드 대표자 탈퇴 (다른 사용자 있음)
1. advertiser_admin 계정으로 로그인
2. 프로필 편집 → "회원탈퇴" 클릭
3. 소유권 이전 모달에서 새 대표자 선택
4. 삭제 확인 모달에서 "회원탈퇴" 입력
5. 소유권 이전 및 계정 삭제 확인

### 3. 브랜드 대표자 탈퇴 (다른 사용자 없음)
1. 유일한 advertiser_admin 계정으로 로그인
2. 프로필 편집 → "회원탈퇴" 클릭
3. 경고 메시지 확인
4. "브랜드 삭제" 버튼 비활성화 확인

### 4. Master 계정 탈퇴 시도
1. master 계정으로 로그인
2. 프로필 편집에서 "회원탈퇴" 버튼 비활성화 확인
3. 툴팁 메시지 확인

### 5. 디버깅 로그 확인
브라우저 개발자 도구 콘솔에서:
- `[OwnershipTransferModal] Loading brand users`
- `[getBrandUsersForTransfer] 조회 시작`
- `[OwnershipTransferModal] Loaded users`

---

## 데이터 보존 정책

### 삭제되는 데이터
- ✅ users 테이블의 사용자 레코드
- ✅ user_advertisers 관계 레코드
- ✅ invitation_codes (작성자가 생성한 초대 코드)
- ✅ ad_creatives (브랜드 삭제 시)

### 보존되는 데이터
- ✅ api_tokens (브랜드 소유, advertiser_id는 NULL로 설정)
- ✅ board_posts (게시글, created_by는 NULL로 설정)
- ✅ 광고 성과 데이터
- ✅ 감사 로그 (user_deletion_log)

---

## 향후 개선 사항

1. **브랜드 삭제 기능**
   - 브랜드에 사용자가 없을 때 브랜드 자체를 삭제하는 기능
   - API 토큰, 광고 데이터 등 전체 삭제

2. **탈퇴 사유 수집**
   - 선택적 탈퇴 사유 입력란
   - 통계 및 개선에 활용

3. **복구 기간 설정**
   - Soft delete 방식 고려
   - 30일 복구 기간 설정

4. **이메일 알림**
   - 탈퇴 완료 이메일
   - 브랜드 대표자 변경 알림

---

## 관련 파일

### 데이터베이스
- `database/041_user_deletion_constraints.sql`

### Edge Functions
- `supabase/functions/get-brand-users/index.ts`
- `supabase/functions/delete-user/index.ts`

### 프론트엔드
- `src/services/supabaseService.js` (라인 2892-2961)
- `src/views/admin/profile/components/DeleteAccountConfirmModal.js` (신규)
- `src/views/admin/profile/components/OwnershipTransferModal.js` (신규)
- `src/views/admin/profile/components/ProfileEditModal.js` (수정)

### 컨텍스트
- `src/contexts/AuthContext.js` (참조용, 수정 없음)

---

## 플랜 파일
플랜 파일은 생성되지 않았음 (대화 요약에서 복원)

---

## 주의사항

1. **데이터베이스 마이그레이션 필수**
   - Edge Function 배포 전에 SQL 마이그레이션 먼저 실행

2. **Edge Function 배포**
   - 현재 배포 권한 부족으로 수동 배포 필요
   - Supabase Dashboard에서 직접 배포 또는 관리자에게 요청

3. **RLS 정책 확인**
   - `user_advertisers` 테이블 읽기 권한 확인
   - Edge Function에서 사용자 목록 조회 가능 여부 확인

4. **테스트 환경에서 먼저 테스트**
   - 프로덕션 배포 전 스테이징 환경에서 충분한 테스트

---

## 배포 체크리스트

- [ ] 데이터베이스 마이그레이션 실행
- [ ] Edge Function 배포 (get-brand-users)
- [ ] Edge Function 배포 (delete-user)
- [ ] 프론트엔드 빌드 및 배포
- [ ] 일반 사용자 탈퇴 테스트
- [ ] 브랜드 대표자 소유권 이전 테스트
- [ ] Master 계정 보호 확인
- [ ] 감사 로그 기록 확인
- [ ] API 토큰 보존 확인
- [ ] 게시글 보존 확인
