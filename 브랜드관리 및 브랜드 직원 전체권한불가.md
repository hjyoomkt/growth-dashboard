# 브랜드 관리 페이지 권한 수정 작업

## 문제 상황
- URL: `http://localhost:3000/brandadmin/brands`
- 증상: 브랜드 관리자가 같은 대행사 소속의 모든 브랜드를 볼 수 있음
- 예상 동작: 브랜드 관리자는 자신에게 할당된 브랜드만 볼 수 있어야 함

## 원인 분석

### 1. supabaseService.js의 getAvailableAdvertisers 함수
**파일**: `src/services/supabaseService.js:158-179`

문제가 된 로직:
```javascript
// "담당 브랜드 전체" 처리: user_advertisers가 비어있고 organization_id가 있으면 조직의 모든 브랜드 반환
if (advertisers.length === 0 && userData.organization_id) {
  // 조직의 모든 브랜드 반환
}
```

- `user_advertisers` 테이블이 비어있으면 "담당 브랜드 전체"로 간주
- 이 로직이 advertiser 역할에도 적용되어 문제 발생

### 2. BrandManagement 컴포넌트
**파일**: `src/views/clientadmin/brands/index.jsx:38-60`

문제가 된 로직:
```javascript
// organizationType으로 판단
if (organizationType === 'agency' && organizationId) {
  // 조직의 모든 브랜드 조회
}
```

- `organizationType`은 조직의 타입(agency/advertiser)을 나타냄
- 브랜드 관리자도 agency 조직에 소속되어 있으면 이 조건이 true가 됨

## 수정 내용

### 1. supabaseService.js 수정
**파일**: `src/services/supabaseService.js:158-164`

```javascript
// 수정 전
if (advertisers.length === 0 && userData.organization_id) {

// 수정 후
if (advertisers.length === 0 && userData.organization_id && isAgency) {
```

- "담당 브랜드 전체" 로직이 **agency 역할만** 적용되도록 제한
- `isAgency` 변수는 `['agency_admin', 'agency_manager', 'agency_staff']` 역할을 체크

### 2. BrandManagement 컴포넌트 수정
**파일**: `src/views/clientadmin/brands/index.jsx:38-42`

```javascript
// 수정 전
if (organizationType === 'agency' && organizationId) {

// 수정 후
const isAgencyRole = ['agency_admin', 'agency_manager', 'agency_staff'].includes(role);

if (isAgencyRole && organizationId) {
```

- `organizationType` 대신 **`role`을 기준으로 판단**
- agency 역할만 조직의 모든 브랜드를 조회하도록 변경

## 결과

### Agency 역할 (대행사)
- `agency_admin` (대표)
- `agency_manager` (매니저)
- `agency_staff` (스태프)

→ **조직의 모든 브랜드 접근 가능**

### Advertiser 역할 (브랜드)
- `advertiser_admin` (브랜드 관리자)
- `advertiser_staff` (브랜드 담당자)
- `viewer` (뷰어)
- `editor` (편집자)

→ **`user_advertisers` 테이블에 명시적으로 등록된 브랜드만 접근 가능**

## 제약 사항

현재 수정으로 인해 **브랜드 직원에게 "전체 브랜드 권한"을 줄 수 없습니다.**

### 현재 로직
- `user_advertisers` 테이블이 **비어있음** → "담당 브랜드 전체" (agency 역할만)
- `user_advertisers` 테이블에 **항목 있음** → 해당 브랜드만

### 향후 개선 방안 (필요시)
브랜드 직원에게도 "전체 브랜드 권한"을 부여해야 한다면:

1. **명시적 플래그 추가**
   - `users` 테이블에 `has_all_brands_access` boolean 컬럼 추가
   - 또는 `user_advertisers` 테이블에 `access_type` 컬럼 추가 ('specific', 'all')

2. **특수 레코드 사용**
   - `user_advertisers`에 `advertiser_id = null`인 특수 레코드로 "전체 접근" 표시

3. **별도 테이블 생성**
   - `user_brand_permissions` 테이블로 세밀한 권한 관리

## 테스트 방법
1. 브라우저 완전 새로고침 (Ctrl+Shift+R)
2. `/brandadmin/brands` 페이지 접속
3. 브라우저 콘솔(F12)에서 `[BrandsManagement]` 로그 확인
4. 자신에게 할당된 브랜드만 표시되는지 확인

## 작업 일시
2026-01-26
