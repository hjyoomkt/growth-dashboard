# 데이터 접근 권한 보안 수정

## 문제 상황

### 재현 환경
- **URL**: `http://localhost:3000/admin/default`
- **사용자**: 에이전시 대표 (agency_admin)
- **Organization ID**: `2fcd99c1-bba1-4b53-9e1c-f084261dacba`
- **브랜드 수**: 0개 (organization에 브랜드가 없음)

### 증상
브랜드가 없는 상태에서 **타 조직의 모든 데이터가 조회**되고 있음

### 영향 범위
- `/admin/default` - 메인 대시보드
- `/admin/data-tables` - 데이터 테이블
- 모든 차트 및 통계 컴포넌트

## 원인 분석

### 1. JavaScript 로직
**파일**: `src/views/admin/default/index.jsx:84-96`

```javascript
const availableAdvertiserIds = (availableAdvertisers || []).map(adv => adv.id);
// availableAdvertisers가 빈 배열 → availableAdvertiserIds = []

const data = await getKPIData({
  advertiserId: currentAdvertiserId,        // null
  availableAdvertiserIds,                   // []
  startDate,
  endDate,
});
```

**파일**: `src/services/supabaseService.js:1174-1181`

```javascript
const { data, error } = await supabase.rpc('get_kpi_aggregated', {
  p_advertiser_id: advertiserId || null,                              // null
  p_advertiser_ids: (availableAdvertiserIds && availableAdvertiserIds.length > 0)
    ? availableAdvertiserIds
    : null,  // 빈 배열 → null로 변환
  p_start_date: startDate || null,
  p_end_date: endDate || null,
  p_meta_conversion_type: metaConversionType
});
```

### 2. SQL RPC 함수 로직 (문제 발생 지점)
**파일**: `database/migrations/add_aggregation_functions.sql:38-42`

```sql
WHERE ap.deleted_at IS NULL
  AND (p_advertiser_id IS NULL OR ap.advertiser_id = p_advertiser_id)
  AND (p_advertiser_ids IS NULL OR ap.advertiser_id = ANY(p_advertiser_ids))
  AND (p_start_date IS NULL OR ap.date >= p_start_date)
  AND (p_end_date IS NULL OR ap.date <= p_end_date);
```

**문제점:**
- 두 번째 조건: `p_advertiser_ids IS NULL`이 true가 되면 **모든 advertiser의 데이터를 반환**
- 이 조건과 첫 번째 조건이 AND로 연결되어 있어, 두 조건을 모두 만족해야 함
- 하지만 `p_advertiser_ids IS NULL`이면 두 번째 조건이 항상 true가 되어 필터링 실패

### 3. 실제 데이터 검증

**브랜드 없는 사용자 (문제 상황):**
```javascript
// 콘솔 로그
[getKPIData] RPC 호출 파라미터: {
  p_advertiser_id: null,
  p_advertiser_ids: null  // ← 문제!
}
```

**SQL 테스트:**
```sql
SELECT * FROM get_daily_aggregated(
  p_advertiser_id := NULL,
  p_advertiser_ids := NULL,
  p_start_date := '2026-01-26',
  p_end_date := '2026-02-01',
  p_meta_conversion_type := 'purchase'
);
-- 결과: 7개 행 반환 (타 조직 데이터 포함) ← 보안 취약점!
```

**정상 사용자 (브랜드 선택):**
```javascript
[getKPIData] RPC 호출 파라미터: {
  p_advertiser_id: 'b80f0d5a-9b15-4bb9-aedb-5e8ac5af1eaf',  // 선택한 브랜드
  p_advertiser_ids: ['b80f0d5a-...', 'c77498a2-...', ...]   // 접근 가능한 4개 브랜드
}
```

## 수정 내용

### SQL RPC 함수 WHERE 조건 수정 (두 번째 조건만)

**수정 전:**
```sql
AND (p_advertiser_id IS NULL OR ap.advertiser_id = p_advertiser_id)
AND (p_advertiser_ids IS NULL OR ap.advertiser_id = ANY(p_advertiser_ids))
```

**수정 후:**
```sql
AND (p_advertiser_id IS NULL OR ap.advertiser_id = p_advertiser_id)
AND (p_advertiser_ids IS NOT NULL AND ap.advertiser_id = ANY(p_advertiser_ids))
```

### 수정 로직 설명

**핵심:** 첫 번째 조건은 유지하고, 두 번째 조건의 `IS NULL` → `IS NOT NULL`로 변경

| 시나리오 | p_advertiser_id | p_advertiser_ids | 첫 번째 조건 | 두 번째 조건 | 최종 결과 (AND) |
|---------|-----------------|------------------|------------|------------|----------------|
| **브랜드 선택** | 'b80f0d5a...' | `[4개 배열]` | FALSE OR (match) = **선택한 브랜드만** | TRUE AND (in array) = **4개 중 하나** | **선택한 브랜드만** ✅ |
| **전체 보기** | NULL | `[4개 배열]` | TRUE OR ... = **항상 TRUE** | TRUE AND (in array) = **4개 중 하나** | **4개 모두** ✅ |
| **브랜드 없음** | NULL | NULL | TRUE OR ... = **항상 TRUE** | FALSE AND ... = **항상 FALSE** | **0개 (차단)** ✅ |

### 수정된 함수 목록

모든 집계 함수에 동일한 수정 적용 (12개):

1. `get_kpi_aggregated` - KPI 총합
2. `get_daily_aggregated` - 일별 집계
3. `get_media_aggregated` - 매체별 집계
4. `get_weekly_aggregated` - 주별 집계
5. `get_monthly_aggregated` - 월별 집계
6. `get_weekday_aggregated` - 요일별 집계
7. `get_creative_aggregated` - 크리에이티브별 집계
8. `get_gender_aggregated` - 성별 집계
9. `get_age_gender_aggregated` - 연령대별 성별 집계
10. `get_campaign_aggregated` - 캠페인별 집계
11. `get_ad_group_aggregated` - 광고그룹별 집계
12. `get_ad_aggregated` - 광고별 집계

## 배포 방법

### 1단계: 백업 (필수)
```sql
-- 실행: database/migrations/backup_current_functions.sql
-- 결과를 복사하여 저장
```

### 2단계: SQL 마이그레이션 적용
Supabase SQL Editor에서 실행:
```sql
-- 파일: database/migrations/fix_data_access_security.sql
```

### 3단계: 검증
```sql
-- 파일: database/migrations/verify_fix.sql
```

**예상 결과:**
- 테스트 1 (NULL 파라미터): **0개 행** 반환 (수정 전: 7개 행)
- 테스트 2 (빈 배열): **0개 행** 반환

### 4단계: 롤백 (문제 발생 시)
```sql
-- 파일: database/migrations/rollback_to_original.sql
```

### 5단계: 애플리케이션 테스트

#### 브랜드 없는 사용자
1. 브라우저 새로고침 (Ctrl+Shift+R)
2. test01@zestdot.com (agency_admin, 브랜드 없음) 로그인
3. `/admin/default` 접속
4. **예상:** 모든 지표가 0, 데이터 없음 ✅

#### 정상 사용자 (브랜드 있음)
1. 브라우저 새로고침
2. 브랜드가 할당된 사용자 로그인
3. 브랜드 선택
4. **예상:** 선택한 브랜드 데이터만 표시 ✅

## 영향 평가

### 긍정적 영향
- ✅ **보안 취약점 해결**: 타 조직 데이터 접근 완전 차단
- ✅ **권한 관리 강화**: p_advertiser_ids가 NULL이면 데이터 없음
- ✅ **정상 사용자 영향 없음**: 브랜드 선택 및 전체 보기 정상 작동

### 부정적 영향
- ⚠️ 브랜드가 없는 사용자는 빈 화면 (의도된 동작)
- ⚠️ 에이전시 대표는 브랜드를 먼저 생성해야 함

## 파일 구조

```
database/migrations/
├── backup_current_functions.sql    # 백업 쿼리
├── fix_data_access_security.sql    # 최종 수정 SQL
├── rollback_to_original.sql        # 롤백 SQL
└── verify_fix.sql                  # 검증 쿼리
```

## 관련 문서

- [브랜드관리 및 브랜드 직원 전체권한불가.md](브랜드관리%20및%20브랜드%20직원%20전체권한불가.md) - 유사한 권한 문제 해결 사례

## 작업 일시

2026-02-02
