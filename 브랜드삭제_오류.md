# 브랜드 삭제 오류 수정

## 문제 증상

**UI**: `/admin/profile`에서 브랜드 삭제 시 "서비스 탈퇴 완료" 메시지 표시 + 로그아웃

**실제 DB 상태**:
- `advertisers` 테이블에 브랜드 레코드 **남아있음** ❌
- `auth.users` 테이블에 사용자 인증 정보 **남아있음** ❌
- 재가입 시 "User already registered" 오류

---

## 근본 원인

### 1. ANON_KEY 권한 부족

[src/config/supabase.js:4-6](src/config/supabase.js#L4-L6)
```javascript
const supabaseAnonKey = process.env.REACT_APP_SUPABASE_ANON_KEY;
export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

- **문제**: 브라우저 코드는 ANON_KEY 사용
- **제약**: `supabase.auth.admin.deleteUser()`는 Service Role Key 필요
- **결과**: auth.users 삭제 불가능

### 2. 삭제 순서 문제

**잘못된 순서**:
1. 사용자 삭제 먼저 → auth.uid()가 users에서 사라짐
2. 브랜드 삭제 시도 → RLS 정책이 차단 (auth.uid()가 users에 없음)

**RLS 정책**:
```sql
-- advertisers DELETE 정책
(EXISTS (SELECT 1 FROM users WHERE users.id = auth.uid() AND users.status = 'active'))
```

---

## 해결 방법

### Edge Function 활용

브라우저에서는 Service Role Key를 사용할 수 없으므로, Edge Function을 통해 auth.users 삭제 처리

### 올바른 삭제 순서

1. **브랜드 삭제 전 사용자 목록 조회**
2. **브랜드 삭제** (RLS 통과 - auth.uid()가 아직 users에 존재)
3. **조회된 사용자들을 delete-user Edge Function으로 삭제**

---

## 수정 내용

### 파일: [src/services/supabaseService.js:2638-2730](src/services/supabaseService.js#L2638-L2730)

```javascript
export const deleteBrand = async (brandId, brandName) => {
  try {
    console.log('[deleteBrand] 삭제 시작:', { brandId, brandName });

    // 1. 브랜드 전용 사용자 목록 조회 (에이전시 직원 제외)
    const { data: usersToDelete, error: usersError } = await supabase
      .from('users')
      .select('id, email, name, role')
      .eq('advertiser_id', brandId)
      .not('role', 'in', '(master,agency_staff,agency_admin,agency_manager)');

    if (usersError) {
      console.error('[deleteBrand] 사용자 조회 실패:', usersError);
      throw usersError;
    }

    console.log('[deleteBrand] 삭제할 사용자:', usersToDelete?.length || 0, usersToDelete);

    // 2. api_tokens에 deleted_advertiser_name 저장
    const { error: updateError } = await supabase
      .from('api_tokens')
      .update({ deleted_advertiser_name: brandName })
      .eq('advertiser_id', brandId);

    if (updateError) {
      console.warn('[deleteBrand] api_tokens 업데이트 실패 (비치명적):', updateError);
    }

    // 3. 브랜드 삭제 (RLS 정책 통과를 위해 사용자 삭제 전에!)
    // RLS 정책: DELETE 시 auth.uid()에 해당하는 users 레코드 필요
    const { data: deleteData, error: deleteError } = await supabase
      .from('advertisers')
      .delete()
      .eq('id', brandId);

    if (deleteError) {
      console.error('[deleteBrand] ✗ 브랜드 삭제 실패:', deleteError);
      throw new Error(`브랜드 삭제 실패: ${deleteError.message}`);
    }

    console.log('[deleteBrand] ✓ 브랜드 삭제 완료');

    // 4. 사용자들 삭제 (delete-user Edge Function 사용)
    const { data: { session } } = await supabase.auth.getSession();

    let deletedUsers = [];
    let failedUsers = [];

    if (!session) {
      console.warn('[deleteBrand] ⚠️ 세션 없음 - 사용자 삭제 건너뜀');
    } else if (usersToDelete && usersToDelete.length > 0) {
      const SUPABASE_URL = process.env.REACT_APP_SUPABASE_URL;
      const functionUrl = `${SUPABASE_URL}/functions/v1/delete-user`;

      for (const user of usersToDelete) {
        try {
          console.log(`[deleteBrand] 사용자 삭제 중: ${user.email}`);

          const response = await fetch(functionUrl, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${session.access_token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: user.id }),
          });

          const result = await response.json();

          if (!response.ok) {
            console.error(`[deleteBrand] ✗ ${user.email} 삭제 실패:`, result);
            failedUsers.push(user.email);
          } else {
            console.log(`[deleteBrand] ✓ ${user.email} 삭제 완료`);
            deletedUsers.push(user.email);
          }
        } catch (fetchError) {
          console.error(`[deleteBrand] ✗ ${user.email} 삭제 실패:`, fetchError);
          failedUsers.push(user.email);
        }
      }
    }

    console.log('[deleteBrand] 삭제 완료:', {
      brand: brandName,
      deletedUsers: deletedUsers.length,
      users: deletedUsers,
      failedUsers: failedUsers.length
    });

    return {
      success: true,
      data: deleteData,
      deletedUsers: deletedUsers,
      failedUsers: failedUsers
    };

  } catch (error) {
    console.error('[deleteBrand] 예외 발생:', error);
    throw error;
  }
};
```

---

## 주요 변경 사항

### 1. 삭제 순서 재정렬

**변경 전**:
1. 브랜드 삭제
2. Edge Function 호출 (404 에러 - 브랜드 없음)

**변경 후**:
1. 사용자 목록 조회 (브랜드 삭제 전)
2. 브랜드 삭제
3. 조회된 사용자들을 delete-user Edge Function으로 삭제

### 2. Edge Function 활용

**기존 delete-user Edge Function** 사용:
- Service Role Key로 auth.users 삭제
- 이메일 익명화 (`deleted-{user_id}@deleted.local`)
- users 테이블 삭제
- 재가입 가능

**위치**: [supabase/functions/delete-user/index.ts:260-316](supabase/functions/delete-user/index.ts#L260-L316)

### 3. 에이전시 직원 보호

```javascript
.not('role', 'in', '(master,agency_staff,agency_admin,agency_manager)')
```

브랜드 삭제 시 에이전시 직원 계정은 유지 (`advertiser_id`만 NULL로 변경)

---

## 테스트 절차

### 1. 브랜드 삭제 테스트

1. 테스트 브랜드 + 사용자 생성
2. `/admin/profile`에서 브랜드 삭제
3. 브라우저 콘솔 확인:
   ```
   [deleteBrand] 삭제할 사용자: 1 [{id: '...', email: 'test@example.com', ...}]
   [deleteBrand] ✓ 브랜드 삭제 완료
   [deleteBrand] 사용자 삭제 중: test@example.com
   [deleteBrand] ✓ test@example.com 삭제 완료
   ```

### 2. DB 검증

```sql
-- advertisers 테이블 확인 (0 rows 예상)
SELECT * FROM advertisers WHERE name = '테스트브랜드';

-- users 테이블 확인 (0 rows 예상)
SELECT * FROM users WHERE email = 'test@example.com';
```

Supabase Dashboard → Authentication → Users에서 auth.users 삭제 확인

### 3. 재가입 테스트

1. 삭제된 이메일로 새 초대 코드 발급
2. 재가입 진행
3. **예상 결과**: 성공 (이메일 익명화로 UNIQUE 제약 해제됨)

---

## 생성된 파일 (사용 안 함)

### [supabase/functions/delete-brand-users/index.ts](supabase/functions/delete-brand-users/index.ts)

처음에는 새 Edge Function을 만들었으나, 기존 `delete-user` Edge Function을 재사용하는 것이 더 효율적이라 판단하여 사용하지 않음.

배포는 되었지만 실제 코드에서는 호출하지 않습니다.

---

## 관련 문서

- [회원가입_재가입.md](회원가입_재가입.md) - 이메일 익명화 패턴
- [브랜드삭제기능.md](브랜드삭제기능.md) - 기존 브랜드 삭제 구현 (auth.users 삭제 누락됨)
- [database/042_brand_deletion_constraints.sql](database/042_brand_deletion_constraints.sql) - FK 제약 조건

---

## 주의사항

### ⚠️ RLS 정책

- advertisers DELETE 정책이 auth.uid() 존재 여부 체크
- 사용자를 먼저 삭제하면 브랜드 삭제 불가능
- 반드시 브랜드 삭제 → 사용자 삭제 순서 유지

### ⚠️ Service Role Key

- 브라우저에서는 절대 사용 금지
- Edge Function에서만 사용
- auth.users 삭제는 Edge Function 필수

### ⚠️ 에이전시 직원

- master, agency_admin, agency_staff, agency_manager는 삭제 제외
- advertiser_id만 NULL로 변경 (계정 유지)

---

**작성일**: 2026-01-29
**상태**: ✅ 수정 완료, 테스트 대기 중
